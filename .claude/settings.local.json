{
  "permissions": {
    "allow": [
      "Bash(*)",
      "Bash(grep:*)",
      "Bash(ls:*)",
      "Bash(find:*)",
      "Bash(python3 -c:*)",
      "Bash(python3:*)",
      "Bash(node:*)",
      "Bash(npm run build:*)",
      "Bash(test:*)",
      "Bash(docker:*)",
      "Bash(cd:*)",
      "Bash(cd /e/teamindex && go get github.com/go-webauthn/webauthn@latest 2>&1)",
      "Bash(cmd.exe /c \"where go 2>nul && go version 2>nul\" 2>/dev/null || cmd /c \"go version\" 2>/dev/null)",
      "Bash(cmd.exe:*)",
      "Bash(powershell.exe:*)",
      "Bash(cat > \"E:/teamindex/internal/server/handlers_admin.go\" << 'GOEOF'\npackage server\n\nimport \\(\n\t\"net/http\"\n\t\"regexp\"\n\t\"strings\"\n\n\t\"transmtf.com/oidc/internal/store\"\n\\)\n\nvar providerSlugRe = regexp.MustCompile\\(`^[a-z0-9-]+$`\\)\n\nfunc \\(h *Handler\\) AdminDashboard\\(w http.ResponseWriter, r *http.Request\\) {\n\tctx := r.Context\\(\\)\n\td := h.pageData\\(r, \"管理面板\"\\)\n\td.Data = map[string]any{\n\t\t\"Users\":     h.st.CountUsers\\(ctx\\),\n\t\t\"Clients\":   h.st.CountClients\\(ctx\\),\n\t\t\"Projects\":  h.st.CountProjects\\(ctx\\),\n\t\t\"Providers\": h.st.CountOIDCProviders\\(ctx\\),\n\t}\n\th.render\\(w, \"admin_dashboard\", d\\)\n}\n\nfunc \\(h *Handler\\) AdminUsers\\(w http.ResponseWriter, r *http.Request\\) {\n\tusers, _ := h.st.ListUsers\\(r.Context\\(\\)\\)\n\tcustomRoles, _ := h.st.ListCustomRoles\\(r.Context\\(\\)\\)\n\td := h.pageData\\(r, \"用户管理\"\\)\n\td.Data = map[string]any{\n\t\t\"Users\":       users,\n\t\t\"CustomRoles\": customRoles,\n\t}\n\th.render\\(w, \"admin_users\", d\\)\n}\n\nfunc \\(h *Handler\\) AdminUserCreate\\(w http.ResponseWriter, r *http.Request\\) {\n\tif err := r.ParseForm\\(\\); err != nil {\n\t\thttp.Error\\(w, \"bad request\", http.StatusBadRequest\\)\n\t\treturn\n\t}\n\tif !h.verifyCSRFToken\\(r\\) {\n\t\th.csrfFailed\\(w, r\\)\n\t\treturn\n\t}\n\n\temail := strings.TrimSpace\\(r.FormValue\\(\"email\"\\)\\)\n\tpassword := r.FormValue\\(\"password\"\\)\n\tname := strings.TrimSpace\\(r.FormValue\\(\"display_name\"\\)\\)\n\trole := r.FormValue\\(\"role\"\\)\n\tif role == \"\" {\n\t\trole = \"user\"\n\t}\n\n\tctx := r.Context\\(\\)\n\t_, err := h.st.CreateUser\\(ctx, email, password, name, role\\)\n\td := h.pageData\\(r, \"用户管理\"\\)\n\tusers, _ := h.st.ListUsers\\(ctx\\)\n\tcustomRoles, _ := h.st.ListCustomRoles\\(ctx\\)\n\td.Data = map[string]any{\"Users\": users, \"CustomRoles\": customRoles}\n\tif err != nil {\n\t\td.Flash = \"创建失败: \" + err.Error\\(\\)\n\t\td.IsError = true\n\t} else {\n\t\td.Flash = \"用户已创建: \" + email\n\t}\n\th.render\\(w, \"admin_users\", d\\)\n}\n\nfunc \\(h *Handler\\) AdminUserUpdate\\(w http.ResponseWriter, r *http.Request\\) {\n\tif err := r.ParseForm\\(\\); err != nil {\n\t\thttp.Error\\(w, \"bad request\", http.StatusBadRequest\\)\n\t\treturn\n\t}\n\tif !h.verifyCSRFToken\\(r\\) {\n\t\th.csrfFailed\\(w, r\\)\n\t\treturn\n\t}\n\n\tid := r.PathValue\\(\"id\"\\)\n\tname := strings.TrimSpace\\(r.FormValue\\(\"display_name\"\\)\\)\n\trole := r.FormValue\\(\"role\"\\)\n\tactive := r.FormValue\\(\"active\"\\) == \"1\"\n\n\tctx := r.Context\\(\\)\n\t// Protect system admin\n\ttargetUser, _ := h.st.GetUserByID\\(ctx, id\\)\n\tif targetUser != nil && targetUser.Email == h.cfg.AdminEmail {\n\t\trole = \"admin\"\n\t\tactive = true\n\t}\n\n\terr := h.st.UpdateUser\\(ctx, id, name, role, active\\)\n\td := h.pageData\\(r, \"用户管理\"\\)\n\tusers, _ := h.st.ListUsers\\(ctx\\)\n\tcustomRoles, _ := h.st.ListCustomRoles\\(ctx\\)\n\td.Data = map[string]any{\"Users\": users, \"CustomRoles\": customRoles}\n\tif err != nil {\n\t\td.Flash = \"更新失败: \" + err.Error\\(\\)\n\t\td.IsError = true\n\t} else {\n\t\td.Flash = \"更新成功\"\n\t}\n\th.render\\(w, \"admin_users\", d\\)\n}\n\nfunc \\(h *Handler\\) AdminUserDelete\\(w http.ResponseWriter, r *http.Request\\) {\n\tif err := r.ParseForm\\(\\); err != nil {\n\t\thttp.Error\\(w, \"bad request\", http.StatusBadRequest\\)\n\t\treturn\n\t}\n\tif !h.verifyCSRFToken\\(r\\) {\n\t\th.csrfFailed\\(w, r\\)\n\t\treturn\n\t}\n\n\tid := r.PathValue\\(\"id\"\\)\n\tcur := h.currentUser\\(r\\)\n\tctx := r.Context\\(\\)\n\td := h.pageData\\(r, \"用户管理\"\\)\n\n\ttargetUser, _ := h.st.GetUserByID\\(ctx, id\\)\n\tif targetUser != nil && targetUser.Email == h.cfg.AdminEmail {\n\t\tusers, _ := h.st.ListUsers\\(ctx\\)\n\t\tcustomRoles, _ := h.st.ListCustomRoles\\(ctx\\)\n\t\td.Data = map[string]any{\"Users\": users, \"CustomRoles\": customRoles}\n\t\td.Flash = \"系统管理员不可删除\"\n\t\td.IsError = true\n\t\th.render\\(w, \"admin_users\", d\\)\n\t\treturn\n\t}\n\n\tif cur != nil && cur.ID == id {\n\t\tusers, _ := h.st.ListUsers\\(ctx\\)\n\t\tcustomRoles, _ := h.st.ListCustomRoles\\(ctx\\)\n\t\td.Data = map[string]any{\"Users\": users, \"CustomRoles\": customRoles}\n\t\td.Flash = \"不能删除自己\"\n\t\td.IsError = true\n\t\th.render\\(w, \"admin_users\", d\\)\n\t\treturn\n\t}\n\n\tif err := h.st.DeleteUser\\(ctx, id\\); err != nil {\n\t\tusers, _ := h.st.ListUsers\\(ctx\\)\n\t\tcustomRoles, _ := h.st.ListCustomRoles\\(ctx\\)\n\t\td.Data = map[string]any{\"Users\": users, \"CustomRoles\": customRoles}\n\t\td.Flash = \"删除失败: \" + err.Error\\(\\)\n\t\td.IsError = true\n\t\th.render\\(w, \"admin_users\", d\\)\n\t\treturn\n\t}\n\n\tusers, _ := h.st.ListUsers\\(ctx\\)\n\tcustomRoles, _ := h.st.ListCustomRoles\\(ctx\\)\n\td.Data = map[string]any{\"Users\": users, \"CustomRoles\": customRoles}\n\td.Flash = \"删除成功\"\n\th.render\\(w, \"admin_users\", d\\)\n}\n\n// ── Admin user detail ─────────────────────────────────────────\n\nfunc \\(h *Handler\\) AdminUserDetail\\(w http.ResponseWriter, r *http.Request\\) {\n\tid := r.PathValue\\(\"id\"\\)\n\tctx := r.Context\\(\\)\n\tu, err := h.st.GetUserByID\\(ctx, id\\)\n\tif err != nil {\n\t\th.renderError\\(w, r, http.StatusNotFound, \"用户不存在\", id\\)\n\t\treturn\n\t}\n\tidentities, _ := h.st.GetUserIdentitiesByUserID\\(ctx, id\\)\n\tsessions, _ := h.st.GetSessionsByUserID\\(ctx, id\\)\n\taccessTokens, _ := h.st.GetAccessTokensByUserID\\(ctx, id\\)\n\trefreshTokens, _ := h.st.GetRefreshTokensByUserID\\(ctx, id\\)\n\tpasskeys, _ := h.st.GetPasskeyCredentialsByUserID\\(ctx, id\\)\n\n\td := h.pageData\\(r, \"用户详情\"\\)\n\tif flash := r.URL.Query\\(\\).Get\\(\"flash\"\\); flash != \"\" {\n\t\td.Flash = flash\n\t}\n\td.Data = map[string]any{\n\t\t\"User\":          u,\n\t\t\"Identities\":    identities,\n\t\t\"Sessions\":      sessions,\n\t\t\"AccessTokens\":  accessTokens,\n\t\t\"RefreshTokens\": refreshTokens,\n\t\t\"Passkeys\":      passkeys,\n\t\t\"IsSystemAdmin\": u.Email == h.cfg.AdminEmail,\n\t}\n\th.render\\(w, \"admin_user_detail\", d\\)\n}\n\nfunc \\(h *Handler\\) AdminUserResetPassword\\(w http.ResponseWriter, r *http.Request\\) {\n\tif err := r.ParseForm\\(\\); err != nil {\n\t\thttp.Error\\(w, \"bad request\", http.StatusBadRequest\\)\n\t\treturn\n\t}\n\tif !h.verifyCSRFToken\\(r\\) {\n\t\th.csrfFailed\\(w, r\\)\n\t\treturn\n\t}\n\tid := r.PathValue\\(\"id\"\\)\n\tnewPass := r.FormValue\\(\"new_password\"\\)\n\tctx := r.Context\\(\\)\n\tif len\\(newPass\\) < 8 {\n\t\thttp.Redirect\\(w, r, \"/admin/users/\"+id+\"?flash=密码至少8位\", http.StatusFound\\)\n\t\treturn\n\t}\n\tif err := h.st.UpdatePassword\\(ctx, id, newPass\\); err != nil {\n\t\thttp.Redirect\\(w, r, \"/admin/users/\"+id+\"?flash=密码重置失败\", http.StatusFound\\)\n\t\treturn\n\t}\n\thttp.Redirect\\(w, r, \"/admin/users/\"+id+\"?flash=密码已重置\", http.StatusFound\\)\n}\n\nfunc \\(h *Handler\\) AdminUserDisable2FA\\(w http.ResponseWriter, r *http.Request\\) {\n\tif err := r.ParseForm\\(\\); err != nil {\n\t\thttp.Error\\(w, \"bad request\", http.StatusBadRequest\\)\n\t\treturn\n\t}\n\tif !h.verifyCSRFToken\\(r\\) {\n\t\th.csrfFailed\\(w, r\\)\n\t\treturn\n\t}\n\tid := r.PathValue\\(\"id\"\\)\n\tctx := r.Context\\(\\)\n\tif err := h.st.DisableTOTP\\(ctx, id\\); err != nil {\n\t\thttp.Redirect\\(w, r, \"/admin/users/\"+id+\"?flash=关闭2FA失败\", http.StatusFound\\)\n\t\treturn\n\t}\n\thttp.Redirect\\(w, r, \"/admin/users/\"+id+\"?flash=2FA已关闭\", http.StatusFound\\)\n}\n\nfunc \\(h *Handler\\) AdminUserRevokeSession\\(w http.ResponseWriter, r *http.Request\\) {\n\tif err := r.ParseForm\\(\\); err != nil {\n\t\thttp.Error\\(w, \"bad request\", http.StatusBadRequest\\)\n\t\treturn\n\t}\n\tif !h.verifyCSRFToken\\(r\\) {\n\t\th.csrfFailed\\(w, r\\)\n\t\treturn\n\t}\n\tuserID := r.PathValue\\(\"id\"\\)\n\tsessID := r.PathValue\\(\"sid\"\\)\n\t_ = h.st.DeleteSession\\(r.Context\\(\\), sessID\\)\n\thttp.Redirect\\(w, r, \"/admin/users/\"+userID+\"?flash=会话已撤销\", http.StatusFound\\)\n}\n\nfunc \\(h *Handler\\) AdminUserRevokeToken\\(w http.ResponseWriter, r *http.Request\\) {\n\tif err := r.ParseForm\\(\\); err != nil {\n\t\thttp.Error\\(w, \"bad request\", http.StatusBadRequest\\)\n\t\treturn\n\t}\n\tif !h.verifyCSRFToken\\(r\\) {\n\t\th.csrfFailed\\(w, r\\)\n\t\treturn\n\t}\n\tuserID := r.PathValue\\(\"id\"\\)\n\ttokenID := r.PathValue\\(\"tid\"\\)\n\ttokenType := r.FormValue\\(\"type\"\\)\n\tctx := r.Context\\(\\)\n\tif tokenType == \"refresh\" {\n\t\t_ = h.st.RevokeRefreshTokenByID\\(ctx, tokenID\\)\n\t} else {\n\t\t_ = h.st.RevokeAccessTokenByID\\(ctx, tokenID\\)\n\t}\n\thttp.Redirect\\(w, r, \"/admin/users/\"+userID+\"?flash=令牌已撤销\", http.StatusFound\\)\n}\n\n// ── Admin role management ─────────────────────────────────────\n\nfunc \\(h *Handler\\) AdminRoles\\(w http.ResponseWriter, r *http.Request\\) {\n\troles, _ := h.st.ListCustomRoles\\(r.Context\\(\\)\\)\n\td := h.pageData\\(r, \"角色管理\"\\)\n\tif flash := r.URL.Query\\(\\).Get\\(\"flash\"\\); flash != \"\" {\n\t\td.Flash = flash\n\t}\n\td.Data = roles\n\th.render\\(w, \"admin_roles\", d\\)\n}\n\nfunc \\(h *Handler\\) AdminRoleCreate\\(w http.ResponseWriter, r *http.Request\\) {\n\tif err := r.ParseForm\\(\\); err != nil {\n\t\thttp.Error\\(w, \"bad request\", http.StatusBadRequest\\)\n\t\treturn\n\t}\n\tif !h.verifyCSRFToken\\(r\\) {\n\t\th.csrfFailed\\(w, r\\)\n\t\treturn\n\t}\n\tname := strings.TrimSpace\\(strings.ToLower\\(r.FormValue\\(\"name\"\\)\\)\\)\n\tlabel := strings.TrimSpace\\(r.FormValue\\(\"label\"\\)\\)\n\tctx := r.Context\\(\\)\n\td := h.pageData\\(r, \"角色管理\"\\)\n\troles, _ := h.st.ListCustomRoles\\(ctx\\)\n\td.Data = roles\n\tif name == \"\" {\n\t\td.Flash = \"角色名称不能为空\"\n\t\td.IsError = true\n\t\th.render\\(w, \"admin_roles\", d\\)\n\t\treturn\n\t}\n\tif err := h.st.CreateCustomRole\\(ctx, name, label\\); err != nil {\n\t\td.Flash = \"创建失败: \" + err.Error\\(\\)\n\t\td.IsError = true\n\t\th.render\\(w, \"admin_roles\", d\\)\n\t\treturn\n\t}\n\troles, _ = h.st.ListCustomRoles\\(ctx\\)\n\td.Data = roles\n\td.Flash = \"角色已创建\"\n\th.render\\(w, \"admin_roles\", d\\)\n}\n\nfunc \\(h *Handler\\) AdminRoleDelete\\(w http.ResponseWriter, r *http.Request\\) {\n\tif err := r.ParseForm\\(\\); err != nil {\n\t\thttp.Error\\(w, \"bad request\", http.StatusBadRequest\\)\n\t\treturn\n\t}\n\tif !h.verifyCSRFToken\\(r\\) {\n\t\th.csrfFailed\\(w, r\\)\n\t\treturn\n\t}\n\tname := r.PathValue\\(\"name\"\\)\n\tif err := h.st.DeleteCustomRole\\(r.Context\\(\\), name\\); err != nil {\n\t\thttp.Redirect\\(w, r, \"/admin/roles?flash=删除失败: \"+err.Error\\(\\), http.StatusFound\\)\n\t\treturn\n\t}\n\thttp.Redirect\\(w, r, \"/admin/roles\", http.StatusFound\\)\n}\n\n// ── Admin clients ─────────────────────────────────────────────\n\nfunc \\(h *Handler\\) AdminClients\\(w http.ResponseWriter, r *http.Request\\) {\n\tclients, _ := h.st.ListClients\\(r.Context\\(\\)\\)\n\td := h.pageData\\(r, \"应用管理\"\\)\n\td.Data = map[string]any{\"Clients\": clients}\n\th.render\\(w, \"admin_clients\", d\\)\n}\n\nfunc \\(h *Handler\\) AdminClientCreatePage\\(w http.ResponseWriter, r *http.Request\\) {\n\td := h.pageData\\(r, \"创建应用\"\\)\n\th.render\\(w, \"admin_client_create\", d\\)\n}\n\nfunc \\(h *Handler\\) AdminClientCreate\\(w http.ResponseWriter, r *http.Request\\) {\n\tif err := r.ParseForm\\(\\); err != nil {\n\t\thttp.Error\\(w, \"bad request\", http.StatusBadRequest\\)\n\t\treturn\n\t}\n\tif !h.verifyCSRFToken\\(r\\) {\n\t\th.csrfFailed\\(w, r\\)\n\t\treturn\n\t}\n\n\tname := strings.TrimSpace\\(r.FormValue\\(\"name\"\\)\\)\n\tdesc := strings.TrimSpace\\(r.FormValue\\(\"description\"\\)\\)\n\turisRaw := r.FormValue\\(\"redirect_uris\"\\)\n\tscopesRaw := r.FormValue\\(\"scopes\"\\)\n\n\tvar uris []string\n\tfor _, l := range strings.Split\\(urisRaw, \"\\\\n\"\\) {\n\t\tif u := strings.TrimSpace\\(l\\); u != \"\" {\n\t\t\turis = append\\(uris, u\\)\n\t\t}\n\t}\n\tscopes := normalizeScopes\\(strings.Fields\\(scopesRaw\\)\\)\n\tif len\\(scopes\\) == 0 {\n\t\tscopes = []string{\"openid\", \"profile\", \"email\"}\n\t}\n\n\tctx := r.Context\\(\\)\n\td := h.pageData\\(r, \"创建应用\"\\)\n\n\tif name == \"\" {\n\t\td.Flash = \"应用名称不能为空\"\n\t\td.IsError = true\n\t\th.render\\(w, \"admin_client_create\", d\\)\n\t\treturn\n\t}\n\tif len\\(uris\\) == 0 {\n\t\td.Flash = \"至少需要一个 Redirect URI\"\n\t\td.IsError = true\n\t\th.render\\(w, \"admin_client_create\", d\\)\n\t\treturn\n\t}\n\tfor _, u := range uris {\n\t\tif !isAllowedAbsoluteURL\\(u\\) {\n\t\t\td.Flash = \"Redirect URI 不合法: \" + u\n\t\t\td.IsError = true\n\t\t\th.render\\(w, \"admin_client_create\", d\\)\n\t\t\treturn\n\t\t}\n\t}\n\n\tclientID, secret, err := h.st.CreateClient\\(ctx, name, desc, uris, scopes\\)\n\tif err != nil {\n\t\tif strings.Contains\\(err.Error\\(\\), \"unique\"\\) || strings.Contains\\(err.Error\\(\\), \"duplicate\"\\) {\n\t\t\td.Flash = \"应用名称已存在，请使用其他名称\"\n\t\t} else {\n\t\t\td.Flash = \"创建失败: \" + err.Error\\(\\)\n\t\t}\n\t\td.IsError = true\n\t\th.render\\(w, \"admin_client_create\", d\\)\n\t\treturn\n\t}\n\n\td.Flash = \"创建成功\"\n\td.Data = map[string]any{\n\t\t\"NewClientID\": clientID,\n\t\t\"NewSecret\":   secret,\n\t\t\"Name\":        name,\n\t}\n\th.render\\(w, \"admin_client_created\", d\\)\n}\n\nfunc \\(h *Handler\\) AdminClientDetail\\(w http.ResponseWriter, r *http.Request\\) {\n\tid := r.PathValue\\(\"id\"\\)\n\tctx := r.Context\\(\\)\n\tclient, err := h.st.GetClientByID\\(ctx, id\\)\n\tif err != nil {\n\t\th.renderError\\(w, r, http.StatusNotFound, \"应用不存在\", id\\)\n\t\treturn\n\t}\n\tann := h.st.GetClientAnnouncement\\(ctx, client.ClientID\\)\n\td := h.pageData\\(r, client.Name\\)\n\tif flash := r.URL.Query\\(\\).Get\\(\"flash\"\\); flash != \"\" {\n\t\td.Flash = flash\n\t}\n\td.Data = map[string]any{\n\t\t\"Client\":       client,\n\t\t\"Announcement\": ann,\n\t}\n\th.render\\(w, \"admin_client_detail\", d\\)\n}\n\nfunc \\(h *Handler\\) AdminClientUpdate\\(w http.ResponseWriter, r *http.Request\\) {\n\tif err := r.ParseForm\\(\\); err != nil {\n\t\thttp.Error\\(w, \"bad request\", http.StatusBadRequest\\)\n\t\treturn\n\t}\n\tif !h.verifyCSRFToken\\(r\\) {\n\t\th.csrfFailed\\(w, r\\)\n\t\treturn\n\t}\n\n\tid := r.PathValue\\(\"id\"\\)\n\tname := strings.TrimSpace\\(r.FormValue\\(\"name\"\\)\\)\n\tdesc := strings.TrimSpace\\(r.FormValue\\(\"description\"\\)\\)\n\turisRaw := r.FormValue\\(\"redirect_uris\"\\)\n\tscopesRaw := r.FormValue\\(\"scopes\"\\)\n\n\tvar uris []string\n\tfor _, l := range strings.Split\\(urisRaw, \"\\\\n\"\\) {\n\t\tif u := strings.TrimSpace\\(l\\); u != \"\" {\n\t\t\turis = append\\(uris, u\\)\n\t\t}\n\t}\n\tscopes := normalizeScopes\\(strings.Fields\\(scopesRaw\\)\\)\n\tif len\\(scopes\\) == 0 {\n\t\tscopes = []string{\"openid\", \"profile\", \"email\"}\n\t}\n\n\tctx := r.Context\\(\\)\n\tif name == \"\" {\n\t\thttp.Redirect\\(w, r, \"/admin/clients/\"+id+\"?flash=名称不能为空\", http.StatusFound\\)\n\t\treturn\n\t}\n\tif err := h.st.UpdateClient\\(ctx, id, name, desc, uris, scopes\\); err != nil {\n\t\tmsg := \"更新失败\"\n\t\tif strings.Contains\\(err.Error\\(\\), \"unique\"\\) || strings.Contains\\(err.Error\\(\\), \"duplicate\"\\) {\n\t\t\tmsg = \"应用名称已存在\"\n\t\t}\n\t\thttp.Redirect\\(w, r, \"/admin/clients/\"+id+\"?flash=\"+msg, http.StatusFound\\)\n\t\treturn\n\t}\n\thttp.Redirect\\(w, r, \"/admin/clients/\"+id+\"?flash=更新成功\", http.StatusFound\\)\n}\n\nfunc \\(h *Handler\\) AdminClientResetSecret\\(w http.ResponseWriter, r *http.Request\\) {\n\tif err := r.ParseForm\\(\\); err != nil {\n\t\thttp.Error\\(w, \"bad request\", http.StatusBadRequest\\)\n\t\treturn\n\t}\n\tif !h.verifyCSRFToken\\(r\\) {\n\t\th.csrfFailed\\(w, r\\)\n\t\treturn\n\t}\n\n\tid := r.PathValue\\(\"id\"\\)\n\tctx := r.Context\\(\\)\n\tnewSecret, err := h.st.ResetClientSecret\\(ctx, id\\)\n\tif err != nil {\n\t\thttp.Redirect\\(w, r, \"/admin/clients/\"+id+\"?flash=重置失败\", http.StatusFound\\)\n\t\treturn\n\t}\n\tclient, _ := h.st.GetClientByID\\(ctx, id\\)\n\td := h.pageData\\(r, \"Secret 已重置\"\\)\n\td.Flash = \"Client Secret 已重置，请立即保存（只显示一次）\"\n\td.Data = map[string]any{\n\t\t\"Client\":    client,\n\t\t\"NewSecret\": newSecret,\n\t}\n\th.render\\(w, \"admin_client_secret\", d\\)\n}\n\nfunc \\(h *Handler\\) AdminClientDelete\\(w http.ResponseWriter, r *http.Request\\) {\n\tif err := r.ParseForm\\(\\); err != nil {\n\t\thttp.Error\\(w, \"bad request\", http.StatusBadRequest\\)\n\t\treturn\n\t}\n\tif !h.verifyCSRFToken\\(r\\) {\n\t\th.csrfFailed\\(w, r\\)\n\t\treturn\n\t}\n\n\tid := r.PathValue\\(\"id\"\\)\n\tctx := r.Context\\(\\)\n\td := h.pageData\\(r, \"应用管理\"\\)\n\tif err := h.st.DeleteClient\\(ctx, id\\); err != nil {\n\t\td.Flash = \"删除失败: \" + err.Error\\(\\)\n\t\td.IsError = true\n\t} else {\n\t\td.Flash = \"删除成功\"\n\t}\n\tclients, _ := h.st.ListClients\\(ctx\\)\n\td.Data = map[string]any{\"Clients\": clients}\n\th.render\\(w, \"admin_clients\", d\\)\n}\n\n// ── Admin announcements ───────────────────────────────────────\n\nfunc \\(h *Handler\\) AdminAnnouncements\\(w http.ResponseWriter, r *http.Request\\) {\n\tclients, _ := h.st.ListClients\\(r.Context\\(\\)\\)\n\ttype clientWithAnn struct {\n\t\t*store.OAuthClient\n\t\tAnnouncement string\n\t}\n\tvar items []clientWithAnn\n\tfor _, c := range clients {\n\t\titems = append\\(items, clientWithAnn{\n\t\t\tOAuthClient:  c,\n\t\t\tAnnouncement: h.st.GetClientAnnouncement\\(r.Context\\(\\), c.ClientID\\),\n\t\t}\\)\n\t}\n\td := h.pageData\\(r, \"应用公告\"\\)\n\tif flash := r.URL.Query\\(\\).Get\\(\"flash\"\\); flash != \"\" {\n\t\td.Flash = flash\n\t}\n\td.Data = items\n\th.render\\(w, \"admin_announcements\", d\\)\n}\n\nfunc \\(h *Handler\\) AdminAnnouncementSave\\(w http.ResponseWriter, r *http.Request\\) {\n\tif err := r.ParseForm\\(\\); err != nil {\n\t\thttp.Error\\(w, \"bad request\", http.StatusBadRequest\\)\n\t\treturn\n\t}\n\tif !h.verifyCSRFToken\\(r\\) {\n\t\th.csrfFailed\\(w, r\\)\n\t\treturn\n\t}\n\tclientID := r.PathValue\\(\"clientid\"\\)\n\tcontent := r.FormValue\\(\"content\"\\)\n\tctx := r.Context\\(\\)\n\t_, err := h.st.GetClientByClientID\\(ctx, clientID\\)\n\tif err != nil {\n\t\thttp.Redirect\\(w, r, \"/admin/announcements?flash=应用不存在\", http.StatusFound\\)\n\t\treturn\n\t}\n\tif err := h.st.SetClientAnnouncement\\(ctx, clientID, content\\); err != nil {\n\t\thttp.Redirect\\(w, r, \"/admin/announcements?flash=保存失败\", http.StatusFound\\)\n\t\treturn\n\t}\n\thttp.Redirect\\(w, r, \"/admin/announcements?flash=公告已保存\", http.StatusFound\\)\n}\n\nfunc \\(h *Handler\\) AdminSettings\\(w http.ResponseWriter, r *http.Request\\) {\n\tcfg := h.st.GetAllSettings\\(r.Context\\(\\)\\)\n\td := h.pageData\\(r, \"站点设置\"\\)\n\td.Data = cfg\n\th.render\\(w, \"admin_settings\", d\\)\n}\n\nfunc \\(h *Handler\\) AdminSettingsSave\\(w http.ResponseWriter, r *http.Request\\) {\n\tif err := r.ParseForm\\(\\); err != nil {\n\t\thttp.Error\\(w, \"bad request\", http.StatusBadRequest\\)\n\t\treturn\n\t}\n\tif !h.verifyCSRFToken\\(r\\) {\n\t\th.csrfFailed\\(w, r\\)\n\t\treturn\n\t}\n\n\tctx := r.Context\\(\\)\n\tkeys := []string{\n\t\t\"site_name\", \"contact_email\", \"site_icon_url\",\n\t\t\"ann_zh\", \"ann_en\",\n\t\t\"tos_content\", \"privacy_content\",\n\t\t\"email_provider\",\n\t\t\"smtp_host\", \"smtp_port\", \"smtp_user\", \"smtp_pass\", \"smtp_from\",\n\t\t\"resend_api_key\", \"resend_from\",\n\t}\n\tfor _, k := range keys {\n\t\t_ = h.st.SetSetting\\(ctx, k, r.FormValue\\(k\\)\\)\n\t}\n\tcfg := h.st.GetAllSettings\\(ctx\\)\n\td := h.pageData\\(r, \"站点设置\"\\)\n\td.Data = cfg\n\td.Flash = \"设置已保存\"\n\th.render\\(w, \"admin_settings\", d\\)\n}\n\nfunc \\(h *Handler\\) AdminProviders\\(w http.ResponseWriter, r *http.Request\\) {\n\tproviders, _ := h.st.ListOIDCProviders\\(r.Context\\(\\)\\)\n\td := h.pageData\\(r, \"登录方式\"\\)\n\td.Data = providers\n\th.render\\(w, \"admin_providers\", d\\)\n}\n\nfunc \\(h *Handler\\) AdminProviderCreate\\(w http.ResponseWriter, r *http.Request\\) {\n\tif err := r.ParseForm\\(\\); err != nil {\n\t\thttp.Error\\(w, \"bad request\", http.StatusBadRequest\\)\n\t\treturn\n\t}\n\tif !h.verifyCSRFToken\\(r\\) {\n\t\th.csrfFailed\\(w, r\\)\n\t\treturn\n\t}\n\n\tname := strings.TrimSpace\\(r.FormValue\\(\"name\"\\)\\)\n\tslug := strings.TrimSpace\\(r.FormValue\\(\"slug\"\\)\\)\n\ticon := strings.TrimSpace\\(r.FormValue\\(\"icon\"\\)\\)\n\tclientID := strings.TrimSpace\\(r.FormValue\\(\"client_id\"\\)\\)\n\tclientSecret := r.FormValue\\(\"client_secret\"\\)\n\tissuerURL := strings.TrimSpace\\(r.FormValue\\(\"issuer_url\"\\)\\)\n\tscopes := normalizeScopes\\(strings.Fields\\(strings.TrimSpace\\(r.FormValue\\(\"scopes\"\\)\\)\\)\\)\n\tif len\\(scopes\\) == 0 {\n\t\tscopes = []string{\"openid\", \"email\", \"profile\"}\n\t}\n\n\trenderErr := func\\(msg string\\) {\n\t\td := h.pageData\\(r, \"登录方式\"\\)\n\t\tproviders, _ := h.st.ListOIDCProviders\\(r.Context\\(\\)\\)\n\t\td.Data = providers\n\t\td.Flash = msg\n\t\td.IsError = true\n\t\th.render\\(w, \"admin_providers\", d\\)\n\t}\n\n\tif name == \"\" || slug == \"\" || clientID == \"\" || clientSecret == \"\" || issuerURL == \"\" {\n\t\trenderErr\\(\"请填写完整的提供商配置\"\\)\n\t\treturn\n\t}\n\tif !providerSlugRe.MatchString\\(slug\\) {\n\t\trenderErr\\(\"Slug 只能包含小写字母、数字、-\"\\)\n\t\treturn\n\t}\n\tif !isAllowedAbsoluteURL\\(issuerURL\\) {\n\t\trenderErr\\(\"Issuer URL 必须是 HTTPS，或 localhost/127.0.0.1 的 HTTP\"\\)\n\t\treturn\n\t}\n\tif !containsScope\\(scopes, \"openid\"\\) {\n\t\trenderErr\\(\"Scopes 必须包含 openid\"\\)\n\t\treturn\n\t}\n\n\tctx := r.Context\\(\\)\n\terr := h.st.CreateOIDCProvider\\(ctx, name, slug, icon, clientID, clientSecret, issuerURL, strings.Join\\(scopes, \" \"\\)\\)\n\td := h.pageData\\(r, \"登录方式\"\\)\n\tproviders, _ := h.st.ListOIDCProviders\\(ctx\\)\n\td.Data = providers\n\tif err != nil {\n\t\td.Flash = \"创建失败: \" + err.Error\\(\\)\n\t\td.IsError = true\n\t} else {\n\t\td.Flash = \"登录方式已添加\"\n\t}\n\th.render\\(w, \"admin_providers\", d\\)\n}\n\nfunc \\(h *Handler\\) AdminProviderToggle\\(w http.ResponseWriter, r *http.Request\\) {\n\tif err := r.ParseForm\\(\\); err != nil {\n\t\thttp.Error\\(w, \"bad request\", http.StatusBadRequest\\)\n\t\treturn\n\t}\n\tif !h.verifyCSRFToken\\(r\\) {\n\t\th.csrfFailed\\(w, r\\)\n\t\treturn\n\t}\n\tid := r.PathValue\\(\"id\"\\)\n\tctx := r.Context\\(\\)\n\tp, err := h.st.GetOIDCProviderByID\\(ctx, id\\)\n\tif err != nil {\n\t\th.renderError\\(w, r, http.StatusNotFound, \"不存在\", id\\)\n\t\treturn\n\t}\n\t_ = h.st.UpdateOIDCProvider\\(ctx, p.ID, p.Name, p.Icon, p.ClientID, p.ClientSecret, p.IssuerURL, p.Scopes, !p.Enabled\\)\n\thttp.Redirect\\(w, r, \"/admin/providers\", http.StatusFound\\)\n}\n\nfunc \\(h *Handler\\) AdminProviderDelete\\(w http.ResponseWriter, r *http.Request\\) {\n\tif err := r.ParseForm\\(\\); err != nil {\n\t\thttp.Error\\(w, \"bad request\", http.StatusBadRequest\\)\n\t\treturn\n\t}\n\tif !h.verifyCSRFToken\\(r\\) {\n\t\th.csrfFailed\\(w, r\\)\n\t\treturn\n\t}\n\tid := r.PathValue\\(\"id\"\\)\n\t_ = h.st.DeleteOIDCProvider\\(r.Context\\(\\), id\\)\n\thttp.Redirect\\(w, r, \"/admin/providers\", http.StatusFound\\)\n}\nGOEOF)",
      "Bash(cd /e/teamindex && go build ./... 2>&1)",
      "Bash(export PATH=\"$PATH:/c/Program Files/Go/bin:/c/Go/bin\" && cd /e/teamindex && go build ./... 2>&1)",
      "Bash(wc:*)"
    ]
  }
}
