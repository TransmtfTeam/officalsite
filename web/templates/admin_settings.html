{{template "base" .}}

{{define "content"}}
<div class="panel-wrap">
  <aside class="sidebar">
    <div class="sidebar-section">
      <div class="sidebar-title">Admin</div>
      <a class="sidebar-link" href="/admin">Overview</a>
      <a class="sidebar-link" href="/admin/users">Users</a>
      <a class="sidebar-link" href="/admin/groups">Groups</a>
      <a class="sidebar-link" href="/admin/clients">Clients</a>
      <a class="sidebar-link" href="/admin/providers">Providers</a>
      <a class="sidebar-link" href="/admin/roles">Roles</a>
      <a class="sidebar-link" href="/admin/announcements">Announcements</a>
      <a class="sidebar-link active" href="/admin/settings">Settings</a>
    </div>
    <div class="sidebar-section">
      <div class="sidebar-title">Quick Links</div>
      <a class="sidebar-link" href="/">Home</a>
      <a class="sidebar-link" href="/profile">Profile</a>
    </div>
  </aside>

  <main class="panel-content">
    <h1 class="panel-title">Site Settings</h1>
    <p class="panel-sub">Manage site identity, email delivery, and legal pages.</p>

    {{if .Flash}}
    <div class="flash {{if .IsError}}flash-err{{else}}flash-ok{{end}}">{{.Flash}}</div>
    {{end}}

    {{$iconURL := ""}}
    {{with .Data}}{{if index . "site_icon_url"}}{{$iconURL = index . "site_icon_url"}}{{end}}{{end}}

    <div class="form-panel" style="margin-bottom:1.2rem">
      <p class="form-panel-title">Site Icon</p>
      {{if $iconURL}}
      <div style="display:flex;align-items:center;gap:.7rem;margin-bottom:.8rem">
        <img src="{{$iconURL}}" alt="Current icon" style="width:40px;height:40px;object-fit:contain;border-radius:6px;border:1px solid rgba(0,0,0,0.1)">
        <span style="font-size:.82rem;color:var(--text2)">Current icon</span>
      </div>
      {{end}}
      <form method="POST" action="/admin/settings/upload-icon" enctype="multipart/form-data" style="display:flex;gap:.6rem;align-items:center;flex-wrap:wrap">
        <input type="hidden" name="csrf_token" value="{{$.CSRFToken}}">
        <input class="form-control" type="file" name="icon_file" accept="image/png,image/jpeg" required style="max-width:340px">
        <button class="btn btn-primary btn-sm" type="submit">Upload Icon</button>
      </form>
      <p style="font-size:.8rem;color:var(--text2);margin-top:.6rem">Only PNG/JPG are accepted, up to 512 KB.</p>
    </div>

    <form method="POST" action="/admin/settings" class="form-panel">
      <input type="hidden" name="csrf_token" value="{{$.CSRFToken}}">

      <p class="form-panel-title">Basic</p>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Site Name</label>
          <input class="form-control" type="text" name="site_name" value="{{with .Data}}{{index . "site_name"}}{{end}}">
        </div>
        <div class="form-group">
          <label class="form-label">Contact Email</label>
          <input class="form-control" type="email" name="contact_email" value="{{with .Data}}{{index . "contact_email"}}{{end}}" placeholder="contact@example.com">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Site Icon URL (optional)</label>
          <input class="form-control" type="text" name="site_icon_url" value="{{with .Data}}{{index . "site_icon_url"}}{{end}}" placeholder="https://example.com/favicon.ico">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Announcement (ZH)</label>
          <textarea class="form-control" name="ann_zh" rows="3" placeholder="Optional global announcement in Chinese">{{with .Data}}{{index . "ann_zh"}}{{end}}</textarea>
        </div>
        <div class="form-group">
          <label class="form-label">Announcement (EN)</label>
          <textarea class="form-control" name="ann_en" rows="3" placeholder="Optional global announcement in English">{{with .Data}}{{index . "ann_en"}}{{end}}</textarea>
        </div>
      </div>

      <hr style="border:none;border-top:1px solid rgba(0,0,0,0.07);margin:1.2rem 0">

      <p class="form-panel-title">Email Delivery</p>
      <div class="form-row">
        <div class="form-group" style="max-width:240px">
          <label class="form-label">Provider</label>
          <select class="form-control" name="email_provider" id="email-provider-select">
            <option value="" {{if eq (index .Data "email_provider") ""}}selected{{end}}>Disabled</option>
            <option value="smtp" {{if eq (index .Data "email_provider") "smtp"}}selected{{end}}>SMTP</option>
            <option value="resend" {{if eq (index .Data "email_provider") "resend"}}selected{{end}}>Resend</option>
          </select>
        </div>
      </div>

      <div id="smtp-section">
        <p style="font-size:.85rem;font-weight:600;color:var(--text2);margin:.8rem 0 .5rem">SMTP</p>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Host</label>
            <input class="form-control" type="text" name="smtp_host" value="{{with .Data}}{{index . "smtp_host"}}{{end}}" placeholder="smtp.example.com">
          </div>
          <div class="form-group" style="max-width:140px">
            <label class="form-label">Port</label>
            <input class="form-control" type="text" name="smtp_port" value="{{with .Data}}{{index . "smtp_port"}}{{end}}" placeholder="587">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Username</label>
            <input class="form-control" type="text" name="smtp_user" value="{{with .Data}}{{index . "smtp_user"}}{{end}}" placeholder="user@example.com">
          </div>
          <div class="form-group">
            <label class="form-label">Password</label>
            <input class="form-control" type="password" name="smtp_pass" placeholder="Leave blank to keep unchanged">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">From Address</label>
            <input class="form-control" type="text" name="smtp_from" value="{{with .Data}}{{index . "smtp_from"}}{{end}}" placeholder="noreply@example.com">
          </div>
        </div>
      </div>

      <div id="resend-section">
        <p style="font-size:.85rem;font-weight:600;color:var(--text2);margin:.8rem 0 .5rem">Resend</p>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">API Key</label>
            <input class="form-control" type="password" name="resend_api_key" placeholder="re_xxx (leave blank to keep unchanged)">
          </div>
          <div class="form-group">
            <label class="form-label">From Address</label>
            <input class="form-control" type="text" name="resend_from" value="{{with .Data}}{{index . "resend_from"}}{{end}}" placeholder="noreply@example.com">
          </div>
        </div>
      </div>

      <hr style="border:none;border-top:1px solid rgba(0,0,0,0.07);margin:1.2rem 0">

      <p class="form-panel-title">Email Templates (optional HTML)</p>
      <p style="font-size:.82rem;color:var(--text2);margin:0 0 .6rem">
        Variables: <code>{{"{{"}}SiteName{{"}}"}}</code>, <code>{{"{{"}}Name{{"}}"}}</code>,
        <code>{{"{{"}}ProfileURL{{"}}"}}</code>, <code>{{"{{"}}NewPassword{{"}}"}}</code>.
      </p>
      <div class="form-group">
        <label class="form-label">Welcome Email Template</label>
        <textarea class="form-control" name="email_tpl_welcome" rows="6" placeholder="Leave blank to use default template">{{with .Data}}{{index . "email_tpl_welcome"}}{{end}}</textarea>
      </div>
      <div class="form-group">
        <label class="form-label">Password Reset Notification Template</label>
        <textarea class="form-control" name="email_tpl_password_reset" rows="6" placeholder="Leave blank to use default template">{{with .Data}}{{index . "email_tpl_password_reset"}}{{end}}</textarea>
      </div>

      <hr style="border:none;border-top:1px solid rgba(0,0,0,0.07);margin:1.2rem 0">

      <p class="form-panel-title">Legal Content (HTML allowed)</p>
      <div class="form-group">
        <label class="form-label">Terms of Service (/tos)</label>
        <textarea class="form-control" name="tos_content" rows="8" placeholder="Terms content">{{with .Data}}{{index . "tos_content"}}{{end}}</textarea>
      </div>
      <div class="form-group">
        <label class="form-label">Privacy Policy (/privacy)</label>
        <textarea class="form-control" name="privacy_content" rows="8" placeholder="Privacy content">{{with .Data}}{{index . "privacy_content"}}{{end}}</textarea>
      </div>

      <button class="btn btn-primary" type="submit">Save Settings</button>
    </form>
  </main>
</div>

<script>
(function () {
  var select = document.getElementById('email-provider-select');
  if (!select) return;
  var smtp = document.getElementById('smtp-section');
  var resend = document.getElementById('resend-section');

  function syncSections() {
    var v = select.value;
    if (smtp) smtp.style.display = v === 'smtp' ? '' : 'none';
    if (resend) resend.style.display = v === 'resend' ? '' : 'none';
  }

  select.addEventListener('change', syncSections);
  syncSections();
})();
</script>
{{end}}
