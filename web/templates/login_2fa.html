{{template "base" .}}

{{define "content"}}
<div class="auth-page" style="min-height:100vh">
  <div class="auth-card">
    <div class="auth-logo">
      <div class="auth-logo-text">Team TransMTF</div>
    </div>
    <h2 class="auth-title">Two-Factor Verification</h2>

    {{if .Flash}}
    <div class="flash {{if .IsError}}flash-err{{else}}flash-ok{{end}}">{{.Flash}}</div>
    {{end}}

    {{with .Data}}
    <p style="font-size:.9rem;color:var(--text2);margin-bottom:1rem;text-align:center">
      Account: <strong>{{index . "Email"}}</strong>
    </p>

    {{$hasTOTP := index . "HasTOTP"}}
    {{$hasPasskey := index . "HasPasskey"}}

    {{if and $hasTOTP $hasPasskey}}
    <div class="tab-group">
      <div class="tab-bar">
        <button class="tab-btn active" data-tab="tab-totp" type="button">Authenticator Code</button>
        <button class="tab-btn" data-tab="tab-passkey" type="button">Passkey</button>
      </div>

      <div id="tab-totp" class="tab-panel active">
        <form method="POST" action="/login/2fa">
          <input type="hidden" name="csrf_token" value="{{$.CSRFToken}}">
          <div class="form-group">
            <label class="form-label">Authenticator Code</label>
            <input class="form-control" type="text" name="totp_code" inputmode="numeric"
              autocomplete="one-time-code" placeholder="123456" required autofocus>
          </div>
          <button class="btn btn-primary" style="width:100%;justify-content:center" type="submit">Verify and Sign In</button>
        </form>
      </div>

      <div id="tab-passkey" class="tab-panel">
        <p style="font-size:.88rem;color:var(--text2);margin-bottom:1rem;text-align:center">
          Verify with a registered passkey (Face ID / Touch ID / hardware key).
        </p>
        <div id="passkey-login-msg"></div>
        <button id="passkey-login-btn" class="btn btn-primary" style="width:100%;justify-content:center" type="button">
          Use Passkey
        </button>
      </div>
    </div>

    {{else if $hasTOTP}}
    <form method="POST" action="/login/2fa">
      <input type="hidden" name="csrf_token" value="{{$.CSRFToken}}">
      <div class="form-group">
        <label class="form-label">Authenticator Code</label>
        <input class="form-control" type="text" name="totp_code" inputmode="numeric"
          autocomplete="one-time-code" placeholder="123456" required autofocus>
      </div>
      <button class="btn btn-primary" style="width:100%;justify-content:center" type="submit">Verify and Sign In</button>
    </form>

    {{else if $hasPasskey}}
    <p style="font-size:.88rem;color:var(--text2);margin-bottom:1rem;text-align:center">
      Verify with a registered passkey (Face ID / Touch ID / hardware key).
    </p>
    <div id="passkey-login-msg"></div>
    <button id="passkey-login-btn" class="btn btn-primary" style="width:100%;justify-content:center" type="button">
      Use Passkey
    </button>
    {{end}}
    {{end}}

    <p class="auth-footer-link"><a href="/login">Back to login</a></p>
  </div>
</div>
{{end}}
