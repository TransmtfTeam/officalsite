{{template "base" .}}

{{define "content"}}
<div class="panel-wrap">
  <aside class="sidebar">
    <div class="sidebar-section">
      <div class="sidebar-title">ç®¡ç†å¯¼èˆª</div>
      <a class="sidebar-link" href="/admin">æ¦‚è§ˆ</a>
      <a class="sidebar-link" href="/admin/users">ç”¨æˆ·</a>
      <a class="sidebar-link active" href="/admin/users">ç”¨æˆ·è¯¦æƒ…</a>
      <a class="sidebar-link" href="/admin/groups">åˆ†ç»„</a>
      <a class="sidebar-link" href="/admin/clients">åº”ç”¨</a>
      <a class="sidebar-link" href="/admin/providers">ç™»å½•æ–¹å¼</a>
      <a class="sidebar-link" href="/admin/roles">è§’è‰²</a>
      <a class="sidebar-link" href="/admin/announcements">å…¬å‘Š</a>
      <a class="sidebar-link" href="/admin/settings">è®¾ç½®</a>
      <a class="sidebar-link" href="/admin/audit-logs">å®¡è®¡æ—¥å¿—</a>
    </div>
    <div class="sidebar-section">
      <div class="sidebar-title">å¿«é€Ÿå…¥å£</div>
      <a class="sidebar-link" href="/">è¿”å›é¦–é¡µ</a>
      <a class="sidebar-link" href="/profile">ä¸ªäººèµ„æ–™</a>
      <a class="sidebar-link" href="/member/projects">ç¤¾åŒºé¡¹ç›®</a>
    </div>
  </aside>

  <main class="panel-content">
    {{with .Data}}
    {{$user := index . "User"}}
    {{$isSysAdmin := index . "IsSystemAdmin"}}
    {{$curIsSysAdmin := index . "CurrentIsSysAdmin"}}
    {{$customRoles := index . "CustomRoles"}}
    {{/* å½“ç›®æ ‡ç”¨æˆ·ä¸æ˜¯ç®¡ç†å‘˜ï¼Œæˆ–å½“å‰æ“ä½œè€…æ˜¯ç³»ç»Ÿç®¡ç†å‘˜æ—¶ï¼Œå¯ä¿®æ”¹ */}}
    {{$canModify := or (not $user.IsAdmin) $curIsSysAdmin}}

    <div style="margin-bottom:.5rem">
      <a href="/admin/users" style="color:var(--text2);font-size:.9rem">â† ç”¨æˆ·åˆ—è¡¨</a>
    </div>

    {{if $.Flash}}
    <div class="flash {{if $.IsError}}flash-err{{else}}flash-ok{{end}}">{{$.Flash}}</div>
    {{end}}

    <h1 class="panel-title">{{$user.DisplayName}}</h1>
    {{if $isSysAdmin}}<span class="role-badge role-admin" style="margin-bottom:1rem;display:inline-block">ç³»ç»Ÿç®¡ç†å‘˜</span>{{end}}

    <div class="detail-section">
      <div class="detail-section-title">è´¦æˆ·ä¿¡æ¯</div>
      <div class="detail-row"><div class="detail-key">ç”¨æˆ·æ ‡è¯†</div><div class="detail-val mono">{{$user.ID}}</div></div>
      <div class="detail-row"><div class="detail-key">é‚®ç®±</div><div class="detail-val">{{$user.Email}}</div></div>
      <div class="detail-row">
        <div class="detail-key">é‚®ç®±éªŒè¯</div>
        <div class="detail-val">
          {{if $user.EmailVerified}}
          <span style="color:#16a34a">å·²éªŒè¯</span>
          {{if $canModify}}
          <form method="POST" action="/admin/users/{{$user.ID}}/unverify-email" style="display:inline;margin-left:.8rem">
            <input type="hidden" name="csrf_token" value="{{$.CSRFToken}}">
            <button class="btn btn-ghost btn-sm" type="submit"
              data-confirm="æ˜¯å¦å°† {{$user.DisplayName}} çš„é‚®ç®±æ ‡è®°ä¸ºæœªéªŒè¯ï¼Ÿç”¨æˆ·ä¸‹æ¬¡éœ€è¦é‡æ–°éªŒè¯é‚®ç®±ã€‚"
              data-confirm-title="æ ‡è®°ä¸ºæœªéªŒè¯" data-confirm-icon="âœ‰ï¸">æ ‡è®°æœªéªŒè¯</button>
          </form>
          {{end}}
          {{else}}
          <span style="color:#dc2626">æœªéªŒè¯</span>
          {{if $canModify}}
          <form method="POST" action="/admin/users/{{$user.ID}}/verify-email" style="display:inline;margin-left:.8rem">
            <input type="hidden" name="csrf_token" value="{{$.CSRFToken}}">
            <button class="btn btn-ghost btn-sm" type="submit"
              data-confirm="æ˜¯å¦æ‰‹åŠ¨å°† {{$user.DisplayName}} çš„é‚®ç®±æ ‡è®°ä¸ºå·²éªŒè¯ï¼Ÿ"
              data-confirm-title="æ‰‹åŠ¨éªŒè¯é‚®ç®±" data-confirm-icon="âœ…">æ‰‹åŠ¨éªŒè¯</button>
          </form>
          {{end}}
          {{end}}
        </div>
      </div>
      <div class="detail-row"><div class="detail-key">æ˜¾ç¤ºåç§°</div><div class="detail-val">{{$user.DisplayName}}</div></div>
      <div class="detail-row">
        <div class="detail-key">è§’è‰²</div>
        <div class="detail-val">
          <span class="role-badge {{if eq $user.Role "admin"}}role-admin{{else if eq $user.Role "member"}}role-member{{else}}role-user{{end}}">
            {{if eq $user.Role "admin"}}admin{{else if eq $user.Role "member"}}member{{else if eq $user.Role "user"}}user{{else}}{{$user.Role}}{{end}}
          </span>
        </div>
      </div>
      <div class="detail-row">
        <div class="detail-key">çŠ¶æ€</div>
        <div class="detail-val">{{if $user.Active}}<span style="color:#16a34a">å¯ç”¨</span>{{else}}<span style="color:#dc2626">åœç”¨</span>{{end}}</div>
      </div>
      <div class="detail-row">
        <div class="detail-key">ä¸¤æ­¥éªŒè¯</div>
        <div class="detail-val">{{if $user.TOTPEnabled}}<span style="color:#16a34a">å·²å¯ç”¨</span>{{else}}<span style="color:var(--text2)">æœªå¯ç”¨</span>{{end}}</div>
      </div>
      <div class="detail-row"><div class="detail-key">æ³¨å†Œæ—¶é—´</div><div class="detail-val">{{$user.CreatedAt.Format "2006-01-02 15:04:05"}}</div></div>
    </div>

    {{/* â”€â”€ è´¦æˆ·ç¼–è¾‘ â”€â”€ */}}
    <div class="detail-section">
      <div class="detail-section-title">è´¦æˆ·ç¼–è¾‘</div>
      {{if $canModify}}
      <form method="POST" action="/admin/users/{{$user.ID}}/update" style="margin-bottom:1rem">
        <input type="hidden" name="csrf_token" value="{{$.CSRFToken}}">
        <div style="display:flex;gap:.8rem;align-items:flex-end;flex-wrap:wrap">
          <div class="form-group" style="min-width:220px;margin-bottom:0">
            <label class="form-label">æ˜¾ç¤ºåç§°</label>
            <input class="form-control" type="text" name="display_name" value="{{$user.DisplayName}}" required>
          </div>
          <div class="form-group" style="min-width:180px;margin-bottom:0">
            <label class="form-label">è§’è‰²</label>
            <select class="form-control" name="role" required>
              <option value="user" {{if eq $user.Role "user"}}selected{{end}}>user</option>
              <option value="member" {{if eq $user.Role "member"}}selected{{end}}>member</option>
              <option value="admin" {{if eq $user.Role "admin"}}selected{{end}}>admin</option>
              {{range $customRoles}}
              <option value="{{.Name}}" {{if eq $user.Role .Name}}selected{{end}}>{{if .Label}}{{.Label}}{{else}}{{.Name}}{{end}}</option>
              {{end}}
            </select>
          </div>
          <div class="form-group" style="min-width:160px;margin-bottom:0">
            <label class="form-label">è´¦æˆ·çŠ¶æ€</label>
            <select class="form-control" name="active" required>
              <option value="1" {{if $user.Active}}selected{{end}}>æ­£å¸¸</option>
              <option value="0" {{if not $user.Active}}selected{{end}}>å°ç¦</option>
            </select>
          </div>
          <button class="btn btn-primary btn-sm" type="submit"
            data-confirm="ç¡®è®¤ä¿å­˜è¯¥ç”¨æˆ·çš„è´¦æˆ·ä¿¡æ¯ä¿®æ”¹ï¼Ÿ"
            data-confirm-title="ä¿å­˜ä¿®æ”¹" data-confirm-icon="ğŸ’¾">ä¿å­˜</button>
        </div>
      </form>

      <form method="POST" action="/admin/users/{{$user.ID}}/delete">
        <input type="hidden" name="csrf_token" value="{{$.CSRFToken}}">
        <button class="btn btn-danger btn-sm" type="submit"
          data-confirm="æ˜¯å¦ç¡®å®šåˆ é™¤ç”¨æˆ· {{$user.DisplayName}}ï¼Ÿè¯¥æ“ä½œä¸å¯æ’¤é”€ã€‚"
          data-confirm-title="åˆ é™¤ç”¨æˆ·" data-confirm-icon="ğŸ—‘ï¸">åˆ é™¤ç”¨æˆ·</button>
      </form>
      {{else}}
      <p style="font-size:.88rem;color:var(--text2)">å½“å‰è´¦å·ä¸å¯åœ¨æ­¤é¡µé¢ä¿®æ”¹æˆ–åˆ é™¤ã€‚</p>
      {{end}}
    </div>

    {{/* â”€â”€ ç”¨æˆ·åˆ†ç»„ â”€â”€ */}}
    {{$userGroups := index . "UserGroups"}}
    {{$allGroups  := index . "AllGroups"}}
    {{$availableGroups := index . "AvailableGroups"}}
    {{$canManageGroups := index . "CanManageGroups"}}
    <div class="detail-section">
      <div class="detail-section-title">æ‰€å±åˆ†ç»„</div>
      {{if $userGroups}}
      <div style="display:flex;flex-wrap:wrap;gap:.5rem;margin-bottom:1rem">
        {{range $userGroups}}
        <span class="proj-tag" style="display:inline-flex;align-items:center;gap:.4rem">
          {{if .Label}}{{.Label}}{{else}}{{.Name}}{{end}}
          {{if $canManageGroups}}
          <form method="POST" action="/admin/users/{{$user.ID}}/groups/{{.ID}}/remove" style="display:inline">
            <input type="hidden" name="csrf_token" value="{{$.CSRFToken}}">
            <button type="submit" style="background:none;border:none;cursor:pointer;color:#dc2626;font-size:.85rem;padding:0;line-height:1"
              title="ç§»å‡ºåˆ†ç»„"
              data-confirm="æ˜¯å¦å°† {{$user.DisplayName}} ä»åˆ†ç»„ {{if .Label}}{{.Label}}{{else}}{{.Name}}{{end}} ä¸­ç§»é™¤ï¼Ÿ"
              data-confirm-title="ç§»å‡ºåˆ†ç»„" data-confirm-icon="ğŸ‘¤">Ã—</button>
          </form>
          {{end}}
        </span>
        {{end}}
      </div>
      {{else}}
      <p style="font-size:.88rem;color:var(--text2);margin-bottom:.8rem">è¯¥ç”¨æˆ·ä¸å±äºä»»ä½•è‡ªå®šä¹‰åˆ†ç»„</p>
      {{end}}
      {{if and $availableGroups $canManageGroups}}
      <form method="POST" action="/admin/users/{{$user.ID}}/groups/add" style="display:flex;gap:.6rem;align-items:flex-end;flex-wrap:wrap">
        <input type="hidden" name="csrf_token" value="{{$.CSRFToken}}">
        <div class="form-group" style="margin-bottom:0;min-width:180px">
          <label class="form-label">åŠ å…¥åˆ†ç»„</label>
          <select class="form-control" name="group_id" required>
            <option value="">è¯·é€‰æ‹©</option>
            {{range $availableGroups}}
            <option value="{{.ID}}">{{if .Label}}{{.Label}}{{else}}{{.Name}}{{end}}</option>
            {{end}}
          </select>
        </div>
        <button class="btn btn-ghost btn-sm" type="submit">æ·»åŠ </button>
      </form>
      {{else if $canManageGroups}}
      {{if $allGroups}}
      <p style="font-size:.88rem;color:var(--text2);margin-bottom:.2rem">è¯¥ç”¨æˆ·å·²ç»åŠ å…¥äº†æ‰€æœ‰è‡ªå®šä¹‰åˆ†ç»„ã€‚</p>
      {{else}}
      <p style="font-size:.88rem;color:var(--text2);margin-bottom:.2rem">å½“å‰æ²¡æœ‰å¯ç”¨åˆ†ç»„ï¼Œè¯·å…ˆåˆ° <a href="/admin/groups">åˆ†ç»„ç®¡ç†</a> åˆ›å»ºã€‚</p>
      {{end}}
      {{end}}
    </div>

    {{/* â”€â”€ é‡ç½®å¯†ç  â”€â”€ */}}
    {{if $canModify}}
    <div class="detail-section">
      <div class="detail-section-title">é‡ç½®å¯†ç </div>
      <form method="POST" action="/admin/users/{{$user.ID}}/reset-password">
        <input type="hidden" name="csrf_token" value="{{$.CSRFToken}}">
        <div style="display:flex;gap:.8rem;align-items:flex-end;flex-wrap:wrap;margin-bottom:.8rem">
          <div class="form-group" style="flex:1;margin-bottom:0;min-width:220px">
            <label class="form-label">æ–°å¯†ç ï¼ˆè‡³å°‘ 8 ä½ï¼‰</label>
            <input class="form-control" type="password" name="new_password" minlength="8" required>
          </div>
          <button class="btn btn-ghost btn-sm" type="submit"
            data-confirm="æ˜¯å¦ç¡®å®šä¿®æ”¹ {{$user.DisplayName}} çš„å¯†ç ï¼Ÿ"
            data-confirm-title="é‡ç½®å¯†ç " data-confirm-icon="ğŸ”">é‡ç½®å¯†ç </button>
        </div>
        <label style="display:flex;align-items:center;gap:.5rem;cursor:pointer;font-size:.88rem">
          <input type="checkbox" name="require_password_change" value="1">
          <span>è¦æ±‚è¯¥ç”¨æˆ·ä¸‹æ¬¡ç™»å½•åå¿…é¡»ä¿®æ”¹å¯†ç </span>
        </label>
      </form>
    </div>
    {{else}}
    <div class="detail-section">
      <div class="detail-section-title">é‡ç½®å¯†ç </div>
      <p style="font-size:.88rem;color:var(--text2)">ä»…ç³»ç»Ÿç®¡ç†å‘˜å¯ä¿®æ”¹å…¶ä»–ç®¡ç†å‘˜çš„å¯†ç ã€‚</p>
    </div>
    {{end}}

    {{/* â”€â”€ åŒé‡éªŒè¯ç®¡ç† â”€â”€ */}}
    {{if and $user.TOTPEnabled $canModify}}
    <div class="detail-section">
      <div class="detail-section-title">ä¸¤æ­¥éªŒè¯ç®¡ç†</div>
      <p style="font-size:.88rem;color:var(--text2);margin-bottom:.8rem">
        å¼ºåˆ¶å…³é—­ç”¨æˆ·çš„åŠ¨æ€å£ä»¤åŒé‡éªŒè¯ï¼ˆç”¨äºè´¦æˆ·æ¢å¤ï¼‰ã€‚
      </p>
      <form method="POST" action="/admin/users/{{$user.ID}}/disable-2fa">
        <input type="hidden" name="csrf_token" value="{{$.CSRFToken}}">
        <button class="btn btn-ghost btn-sm" type="submit"
          data-confirm="ç¡®è®¤å…³é—­è¯¥ç”¨æˆ·çš„åŒå› ç´ è®¤è¯ï¼Ÿæ­¤æ“ä½œå°†ç«‹å³ç”Ÿæ•ˆã€‚" data-confirm-title="å…³é—­åŒé‡éªŒè¯" data-confirm-icon="ğŸ”">å…³é—­åŒé‡éªŒè¯</button>
      </form>
    </div>
    {{end}}

    {{/* â”€â”€ å¤–éƒ¨èº«ä»½ç»‘å®š â”€â”€ */}}
    {{$identities := index . "Identities"}}
    {{if $identities}}
    <div class="detail-section">
      <div class="detail-section-title">å¤–éƒ¨ç™»å½•è´¦å·</div>
      <table class="data-table">
        <thead><tr><th>æä¾›å•†</th><th>å¤–éƒ¨æ ‡è¯†</th><th>å…³è”æ—¶é—´</th></tr></thead>
        <tbody>
          {{range $identities}}
          <tr>
            <td>{{.Provider}}</td>
            <td class="mono" style="font-size:.8rem">{{.Subject}}</td>
            <td>{{.CreatedAt.Format "2006-01-02 15:04"}}</td>
          </tr>
          {{end}}
        </tbody>
      </table>
    </div>
    {{end}}

    {{/* â”€â”€ é€šè¡Œå¯†é’¥ â”€â”€ */}}
    {{$passkeys := index . "Passkeys"}}
    <div class="detail-section">
      <div class="detail-section-title">é€šè¡Œå¯†é’¥ï¼ˆ{{len $passkeys}} ä¸ªï¼‰</div>
      {{if $passkeys}}
      {{range $passkeys}}
      <div class="passkey-item">
        <div class="passkey-icon">ğŸ”‘</div>
        <div class="passkey-info">
          <div class="passkey-name">{{.Name}}</div>
          <div class="passkey-date">æ³¨å†Œäº {{.CreatedAt.Format "2006-01-02"}}</div>
        </div>
        {{if $canModify}}
        <form method="POST" action="/admin/users/{{$user.ID}}/passkeys/{{.ID}}/delete">
          <input type="hidden" name="csrf_token" value="{{$.CSRFToken}}">
          <button class="btn btn-danger btn-sm" type="submit"
            data-confirm="ç¡®è®¤åˆ é™¤æ­¤é€šè¡Œå¯†é’¥å—ï¼Ÿç”¨æˆ·å°†æ— æ³•å†ä½¿ç”¨è¯¥è®¾å¤‡ç™»å½•ã€‚"
            data-confirm-title="åˆ é™¤é€šè¡Œå¯†é’¥" data-confirm-icon="ğŸ”‘">åˆ é™¤</button>
        </form>
        {{end}}
      </div>
      {{end}}
      {{else}}
      <p style="font-size:.88rem;color:var(--text2)">æœªæ³¨å†Œä»»ä½•é€šè¡Œå¯†é’¥</p>
      {{end}}
    </div>

    {{/* â”€â”€ ä¼šè¯ â”€â”€ */}}
    {{$sessions := index . "Sessions"}}
    <div class="detail-section">
      <div class="detail-section-title">æ´»è·ƒä¼šè¯ï¼ˆ{{len $sessions}} ä¸ªï¼‰</div>
      {{if $sessions}}
      <table class="data-table">
        <thead><tr><th>ä¼šè¯æ ‡è¯†</th><th>åˆ›å»ºæ—¶é—´</th><th>è¿‡æœŸæ—¶é—´</th><th>æ“ä½œ</th></tr></thead>
        <tbody>
          {{range $sessions}}
          <tr>
            <td class="mono" style="font-size:.75rem">{{slice .ID 0 8}}â€¦</td>
            <td>{{.CreatedAt.Format "2006-01-02 15:04"}}</td>
            <td>{{.ExpiresAt.Format "2006-01-02 15:04"}}</td>
            <td>
              <form method="POST" action="/admin/users/{{$user.ID}}/sessions/{{.ID}}/revoke">
                <input type="hidden" name="csrf_token" value="{{$.CSRFToken}}">
                <button class="btn btn-danger btn-sm" type="submit"
                  data-confirm="ç¡®è®¤æ’¤é”€æ­¤ä¼šè¯å—ï¼Ÿè¯¥è®¾å¤‡å°†éœ€è¦é‡æ–°ç™»å½•ã€‚"
                  data-confirm-title="æ’¤é”€ä¼šè¯" data-confirm-icon="âš ï¸">æ’¤é”€</button>
              </form>
            </td>
          </tr>
          {{end}}
        </tbody>
      </table>
      {{else}}
      <p style="font-size:.88rem;color:var(--text2)">æ— æ´»è·ƒä¼šè¯</p>
      {{end}}
    </div>

    {{/* â”€â”€ è®¿é—®ä»¤ç‰Œ â”€â”€ */}}
    {{$ats := index . "AccessTokens"}}
    {{if $ats}}
    <div class="detail-section">
      <div class="detail-section-title">è®¿é—®ä»¤ç‰Œï¼ˆ{{len $ats}} ä¸ªï¼‰</div>
      <table class="data-table">
        <thead><tr><th>æ ‡è¯†</th><th>å®¢æˆ·ç«¯</th><th>æƒé™èŒƒå›´</th><th>è¿‡æœŸ</th><th>æ“ä½œ</th></tr></thead>
        <tbody>
          {{range $ats}}
          <tr>
            <td class="mono" style="font-size:.75rem">{{slice .ID 0 8}}â€¦</td>
            <td class="mono" style="font-size:.75rem">{{.ClientID}}</td>
            <td style="font-size:.8rem">{{range .Scopes}}<span class="proj-tag">{{.}}</span> {{end}}</td>
            <td style="font-size:.8rem">{{.ExpiresAt.Format "01-02 15:04"}}</td>
            <td>
              <form method="POST" action="/admin/users/{{$user.ID}}/tokens/{{.ID}}/revoke">
                <input type="hidden" name="csrf_token" value="{{$.CSRFToken}}">
                <input type="hidden" name="type" value="access">
                <button class="btn btn-danger btn-sm" type="submit"
                  data-confirm="ç¡®è®¤æ’¤é”€æ­¤è®¿é—®ä»¤ç‰Œå—ï¼Ÿ"
                  data-confirm-title="æ’¤é”€è®¿é—®ä»¤ç‰Œ" data-confirm-icon="âš ï¸">æ’¤é”€</button>
              </form>
            </td>
          </tr>
          {{end}}
        </tbody>
      </table>
    </div>
    {{end}}

    {{/* â”€â”€ åˆ·æ–°ä»¤ç‰Œ â”€â”€ */}}
    {{$rts := index . "RefreshTokens"}}
    {{if $rts}}
    <div class="detail-section">
      <div class="detail-section-title">åˆ·æ–°ä»¤ç‰Œï¼ˆ{{len $rts}} ä¸ªï¼‰</div>
      <table class="data-table">
        <thead><tr><th>æ ‡è¯†</th><th>å®¢æˆ·ç«¯</th><th>æƒé™èŒƒå›´</th><th>è¿‡æœŸ</th><th>æ“ä½œ</th></tr></thead>
        <tbody>
          {{range $rts}}
          <tr>
            <td class="mono" style="font-size:.75rem">{{slice .ID 0 8}}â€¦</td>
            <td class="mono" style="font-size:.75rem">{{.ClientID}}</td>
            <td style="font-size:.8rem">{{range .Scopes}}<span class="proj-tag">{{.}}</span> {{end}}</td>
            <td style="font-size:.8rem">{{.ExpiresAt.Format "01-02 15:04"}}</td>
            <td>
              <form method="POST" action="/admin/users/{{$user.ID}}/tokens/{{.ID}}/revoke">
                <input type="hidden" name="csrf_token" value="{{$.CSRFToken}}">
                <input type="hidden" name="type" value="refresh">
                <button class="btn btn-danger btn-sm" type="submit"
                  data-confirm="ç¡®è®¤æ’¤é”€æ­¤åˆ·æ–°ä»¤ç‰Œå—ï¼Ÿ"
                  data-confirm-title="æ’¤é”€åˆ·æ–°ä»¤ç‰Œ" data-confirm-icon="âš ï¸">æ’¤é”€</button>
              </form>
            </td>
          </tr>
          {{end}}
        </tbody>
      </table>
    </div>
    {{end}}

    {{end}}
  </main>
</div>
{{end}}
