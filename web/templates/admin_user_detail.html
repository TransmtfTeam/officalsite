{{template "base" .}}

{{define "content"}}
<div class="panel-wrap">
  <aside class="sidebar">
    <div class="sidebar-section">
      <div class="sidebar-title">Admin</div>
      <a class="sidebar-link" href="/admin">Overview</a>
      <a class="sidebar-link active" href="/admin/users">Users</a>
      <a class="sidebar-link" href="/admin/groups">Groups</a>
      <a class="sidebar-link" href="/admin/clients">Clients</a>
      <a class="sidebar-link" href="/admin/providers">Providers</a>
      <a class="sidebar-link" href="/admin/roles">Roles</a>
      <a class="sidebar-link" href="/admin/announcements">Announcements</a>
      <a class="sidebar-link" href="/admin/settings">Settings</a>
    </div>
    <div class="sidebar-section">
      <div class="sidebar-title">Quick Links</div>
      <a class="sidebar-link" href="/">Home</a>
      <a class="sidebar-link" href="/profile">Profile</a>
    </div>
  </aside>

  <main class="panel-content">
    {{with .Data}}
    {{$user := index . "User"}}
    {{$isSysAdmin := index . "IsSystemAdmin"}}
    {{$curIsSysAdmin := index . "CurrentIsSysAdmin"}}
    {{$canModify := or (not $user.IsAdmin) $curIsSysAdmin}}

    <div style="margin-bottom:.5rem">
      <a href="/admin/users" style="color:var(--text2);font-size:.9rem">Back to users</a>
    </div>

    {{if $.Flash}}
    <div class="flash {{if $.IsError}}flash-err{{else}}flash-ok{{end}}">{{$.Flash}}</div>
    {{end}}

    <h1 class="panel-title">{{$user.DisplayName}}</h1>
    {{if $isSysAdmin}}<span class="role-badge role-admin" style="margin-bottom:1rem;display:inline-block">System Admin</span>{{end}}

    <div class="detail-section">
      <div class="detail-section-title">Account</div>
      <div class="detail-row"><div class="detail-key">User ID</div><div class="detail-val mono">{{$user.ID}}</div></div>
      <div class="detail-row"><div class="detail-key">Email</div><div class="detail-val">{{$user.Email}}</div></div>
      <div class="detail-row">
        <div class="detail-key">Email Verified</div>
        <div class="detail-val">
          {{if $user.EmailVerified}}
          <span style="color:#16a34a">Yes</span>
          {{if $canModify}}
          <form method="POST" action="/admin/users/{{$user.ID}}/unverify-email" style="display:inline;margin-left:.8rem">
            <input type="hidden" name="csrf_token" value="{{$.CSRFToken}}">
            <button class="btn btn-ghost btn-sm" type="submit"
              onclick="return confirm('Mark {{$user.DisplayName}} as unverified? User must verify email again.');">Mark Unverified</button>
          </form>
          {{end}}
          {{else}}
          <span style="color:#dc2626">No</span>
          {{if $canModify}}
          <form method="POST" action="/admin/users/{{$user.ID}}/verify-email" style="display:inline;margin-left:.8rem">
            <input type="hidden" name="csrf_token" value="{{$.CSRFToken}}">
            <button class="btn btn-ghost btn-sm" type="submit"
              onclick="return confirm('Manually verify {{$user.DisplayName}} email now?');">Verify Now</button>
          </form>
          {{end}}
          {{end}}
        </div>
      </div>
      <div class="detail-row"><div class="detail-key">Role</div><div class="detail-val">{{$user.Role}}</div></div>
      <div class="detail-row"><div class="detail-key">Status</div><div class="detail-val">{{if $user.Active}}<span style="color:#16a34a">Active</span>{{else}}<span style="color:#dc2626">Disabled</span>{{end}}</div></div>
      <div class="detail-row"><div class="detail-key">TOTP</div><div class="detail-val">{{if $user.TOTPEnabled}}<span style="color:#16a34a">Enabled</span>{{else}}<span style="color:var(--text2)">Disabled</span>{{end}}</div></div>
      <div class="detail-row"><div class="detail-key">Created</div><div class="detail-val">{{$user.CreatedAt.Format "2006-01-02 15:04:05"}}</div></div>
    </div>

    {{$userGroups := index . "UserGroups"}}
    {{$allGroups := index . "AllGroups"}}
    {{$availableGroups := index . "AvailableGroups"}}
    {{$canManageGroups := index . "CanManageGroups"}}
    <div class="detail-section">
      <div class="detail-section-title">Groups</div>
      {{if $userGroups}}
      <div style="display:flex;flex-wrap:wrap;gap:.5rem;margin-bottom:1rem">
        {{range $userGroups}}
        <span class="proj-tag" style="display:inline-flex;align-items:center;gap:.4rem">
          {{if .Label}}{{.Label}}{{else}}{{.Name}}{{end}}
          {{if $canManageGroups}}
          <form method="POST" action="/admin/users/{{$user.ID}}/groups/{{.ID}}/remove" style="display:inline">
            <input type="hidden" name="csrf_token" value="{{$.CSRFToken}}">
            <button type="submit" style="background:none;border:none;cursor:pointer;color:#dc2626;font-size:.85rem;padding:0;line-height:1"
              title="Remove"
              onclick="return confirm('Remove {{$user.DisplayName}} from group {{if .Label}}{{.Label}}{{else}}{{.Name}}{{end}}?')">x</button>
          </form>
          {{end}}
        </span>
        {{end}}
      </div>
      {{else}}
      <p style="font-size:.88rem;color:var(--text2);margin-bottom:.8rem">This user does not belong to any custom group.</p>
      {{end}}

      {{if and $availableGroups $canManageGroups}}
      <form method="POST" action="/admin/users/{{$user.ID}}/groups/add" style="display:flex;gap:.6rem;align-items:flex-end;flex-wrap:wrap">
        <input type="hidden" name="csrf_token" value="{{$.CSRFToken}}">
        <div class="form-group" style="margin-bottom:0;min-width:180px">
          <label class="form-label">Add to group</label>
          <select class="form-control" name="group_id" required>
            <option value="">Select group</option>
            {{range $availableGroups}}
            <option value="{{.ID}}">{{if .Label}}{{.Label}}{{else}}{{.Name}}{{end}}</option>
            {{end}}
          </select>
        </div>
        <button class="btn btn-ghost btn-sm" type="submit">Add</button>
      </form>
      {{else if $canManageGroups}}
      {{if $allGroups}}
      <p style="font-size:.88rem;color:var(--text2);margin-bottom:.2rem">User is already in all custom groups.</p>
      {{else}}
      <p style="font-size:.88rem;color:var(--text2);margin-bottom:.2rem">No groups available. Create one at <a href="/admin/groups">Group Management</a>.</p>
      {{end}}
      {{end}}
    </div>

    {{if $canModify}}
    <div class="detail-section">
      <div class="detail-section-title">Reset Password</div>
      <form method="POST" action="/admin/users/{{$user.ID}}/reset-password">
        <input type="hidden" name="csrf_token" value="{{$.CSRFToken}}">
        <div style="display:flex;gap:.8rem;align-items:flex-end;flex-wrap:wrap;margin-bottom:.8rem">
          <div class="form-group" style="flex:1;margin-bottom:0;min-width:200px">
            <label class="form-label">New Password (min 8 chars)</label>
            <input class="form-control" type="password" name="new_password" minlength="8" required>
          </div>
          <button class="btn btn-ghost btn-sm" type="submit"
            onclick="return confirm('Reset password for {{$user.DisplayName}}? A password email will be sent.');">Reset Password</button>
        </div>
        <label style="display:flex;align-items:center;gap:.5rem;cursor:pointer;font-size:.88rem">
          <input type="checkbox" name="require_password_change" value="1">
          <span>Require password change at next login</span>
        </label>
      </form>
    </div>
    {{end}}

    {{if and $user.TOTPEnabled $canModify}}
    <div class="detail-section">
      <div class="detail-section-title">2FA Recovery</div>
      <p style="font-size:.88rem;color:var(--text2);margin-bottom:.8rem">Disable TOTP for account recovery.</p>
      <form method="POST" action="/admin/users/{{$user.ID}}/disable-2fa">
        <input type="hidden" name="csrf_token" value="{{$.CSRFToken}}">
        <button class="btn btn-ghost btn-sm" type="submit"
          onclick="return confirm('Disable TOTP for {{$user.DisplayName}} now?')">Disable 2FA</button>
      </form>
    </div>
    {{end}}

    {{$identities := index . "Identities"}}
    {{if $identities}}
    <div class="detail-section">
      <div class="detail-section-title">External Identities</div>
      <table class="data-table">
        <thead><tr><th>Provider</th><th>Subject</th><th>Linked At</th></tr></thead>
        <tbody>
          {{range $identities}}
          <tr>
            <td>{{.Provider}}</td>
            <td class="mono" style="font-size:.8rem">{{.Subject}}</td>
            <td>{{.CreatedAt.Format "2006-01-02 15:04"}}</td>
          </tr>
          {{end}}
        </tbody>
      </table>
    </div>
    {{end}}

    {{$passkeys := index . "Passkeys"}}
    <div class="detail-section">
      <div class="detail-section-title">Passkeys ({{len $passkeys}})</div>
      {{if $passkeys}}
      {{range $passkeys}}
      <div class="passkey-item">
        <div class="passkey-icon">PK</div>
        <div class="passkey-info">
          <div class="passkey-name">{{.Name}}</div>
          <div class="passkey-date">Created {{.CreatedAt.Format "2006-01-02"}}</div>
        </div>
        {{if $canModify}}
        <form method="POST" action="/admin/users/{{$user.ID}}/passkeys/{{.ID}}/delete">
          <input type="hidden" name="csrf_token" value="{{$.CSRFToken}}">
          <button class="btn btn-danger btn-sm" type="submit"
            onclick="return confirm('Delete this passkey for {{$user.DisplayName}}?')">Delete</button>
        </form>
        {{end}}
      </div>
      {{end}}
      {{else}}
      <p style="font-size:.88rem;color:var(--text2)">No passkeys.</p>
      {{end}}
    </div>

    {{$sessions := index . "Sessions"}}
    <div class="detail-section">
      <div class="detail-section-title">Active Sessions ({{len $sessions}})</div>
      {{if $sessions}}
      <table class="data-table">
        <thead><tr><th>Session ID</th><th>Created</th><th>Expires</th><th>Action</th></tr></thead>
        <tbody>
          {{range $sessions}}
          <tr>
            <td class="mono" style="font-size:.75rem">{{slice .ID 0 8}}...</td>
            <td>{{.CreatedAt.Format "2006-01-02 15:04"}}</td>
            <td>{{.ExpiresAt.Format "2006-01-02 15:04"}}</td>
            <td>
              <form method="POST" action="/admin/users/{{$user.ID}}/sessions/{{.ID}}/revoke">
                <input type="hidden" name="csrf_token" value="{{$.CSRFToken}}">
                <button class="btn btn-danger btn-sm" type="submit"
                  onclick="return confirm('Revoke this session? The device will be signed out.');">Revoke</button>
              </form>
            </td>
          </tr>
          {{end}}
        </tbody>
      </table>
      {{else}}
      <p style="font-size:.88rem;color:var(--text2)">No active sessions.</p>
      {{end}}
    </div>

    {{$ats := index . "AccessTokens"}}
    {{if $ats}}
    <div class="detail-section">
      <div class="detail-section-title">Access Tokens ({{len $ats}})</div>
      <table class="data-table">
        <thead><tr><th>ID</th><th>Client</th><th>Scopes</th><th>Expires</th><th>Action</th></tr></thead>
        <tbody>
          {{range $ats}}
          <tr>
            <td class="mono" style="font-size:.75rem">{{slice .ID 0 8}}...</td>
            <td class="mono" style="font-size:.75rem">{{.ClientID}}</td>
            <td style="font-size:.8rem">{{range .Scopes}}<span class="proj-tag">{{.}}</span> {{end}}</td>
            <td style="font-size:.8rem">{{.ExpiresAt.Format "01-02 15:04"}}</td>
            <td>
              <form method="POST" action="/admin/users/{{$user.ID}}/tokens/{{.ID}}/revoke">
                <input type="hidden" name="csrf_token" value="{{$.CSRFToken}}">
                <input type="hidden" name="type" value="access">
                <button class="btn btn-danger btn-sm" type="submit"
                  onclick="return confirm('Revoke this access token?')">Revoke</button>
              </form>
            </td>
          </tr>
          {{end}}
        </tbody>
      </table>
    </div>
    {{end}}

    {{$rts := index . "RefreshTokens"}}
    {{if $rts}}
    <div class="detail-section">
      <div class="detail-section-title">Refresh Tokens ({{len $rts}})</div>
      <table class="data-table">
        <thead><tr><th>ID</th><th>Client</th><th>Scopes</th><th>Expires</th><th>Action</th></tr></thead>
        <tbody>
          {{range $rts}}
          <tr>
            <td class="mono" style="font-size:.75rem">{{slice .ID 0 8}}...</td>
            <td class="mono" style="font-size:.75rem">{{.ClientID}}</td>
            <td style="font-size:.8rem">{{range .Scopes}}<span class="proj-tag">{{.}}</span> {{end}}</td>
            <td style="font-size:.8rem">{{.ExpiresAt.Format "01-02 15:04"}}</td>
            <td>
              <form method="POST" action="/admin/users/{{$user.ID}}/tokens/{{.ID}}/revoke">
                <input type="hidden" name="csrf_token" value="{{$.CSRFToken}}">
                <input type="hidden" name="type" value="refresh">
                <button class="btn btn-danger btn-sm" type="submit"
                  onclick="return confirm('Revoke this refresh token?')">Revoke</button>
              </form>
            </td>
          </tr>
          {{end}}
        </tbody>
      </table>
    </div>
    {{end}}

    {{end}}
  </main>
</div>
{{end}}




