{{template "base" .}}

{{define "content"}}
<div class="profile-page" style="margin-top:60px">
  <h1 style="font-size:1.6rem;font-weight:800;margin-bottom:.3rem">ä¸ªäººèµ„æ–™</h1>
  <p style="color:var(--text2);margin-bottom:1.5rem">ç®¡ç†è´¦æˆ·ä¿¡æ¯ä¸å®‰å…¨è®¾ç½®</p>

  {{if .Flash}}
  <div class="flash {{if .IsError}}flash-err{{else}}flash-ok{{end}}">{{.Flash}}</div>
  {{end}}
  {{with .Data}}{{if index . "PendingSecret"}}<div id="totp-pending-marker" style="display:none"></div>{{end}}{{end}}

  {{with .CurrentUser}}
  <div class="card" style="margin-bottom:1.5rem">
    <p style="font-size:.8rem;color:var(--text2);margin-bottom:1rem">è´¦æˆ·æ¦‚è§ˆ</p>
    <p style="font-size:.9rem;margin-bottom:.3rem">é‚®ç®±ï¼š<strong>{{.Email}}</strong></p>
    <p style="font-size:.9rem;margin-bottom:.3rem">é‚®ç®±éªŒè¯ï¼š
      <strong>{{if .EmailVerified}}<span style="color:#16a34a">å·²éªŒè¯</span>{{else}}<span style="color:#dc2626">æœªéªŒè¯</span>{{end}}</strong>
    </p>
    <p style="font-size:.9rem;margin-bottom:.3rem">è§’è‰²ï¼š<strong>{{.RoleLabel}}</strong></p>
    <p style="font-size:.9rem;margin-bottom:.3rem">ä¸¤æ­¥éªŒè¯ï¼š<strong>{{if .TOTPEnabled}}å·²å¯ç”¨{{else}}æœªå¯ç”¨{{end}}</strong></p>
  </div>

  <div class="card" style="margin-bottom:1.5rem">
    <p class="form-panel-title">å¤–éƒ¨ç™»å½•æ–¹å¼</p>
    <p style="font-size:.88rem;color:var(--text2);margin-bottom:1rem">
      ç»‘å®šåå¯ä½¿ç”¨å¤–éƒ¨è´¦å·ç™»å½•ã€‚ç‚¹å‡»ç»‘å®šä¼šè·³è½¬åˆ°å¯¹åº”å¹³å°æˆæƒé¡µï¼›è§£ç»‘æ— éœ€å¯†ç ã€‚
    </p>
    {{with $.Data}}
    {{$items := index . "ExternalProviders"}}
    {{if $items}}
    {{range $items}}
    <div class="passkey-item">
      <div class="passkey-icon">
        {{$svg := providerIconSVG .Slug .Icon}}
        {{if $svg}}
        <span class="provider-icon">{{$svg}}</span>
        {{else if .Icon}}
        {{.Icon}}
        {{else}}
        ğŸ”
        {{end}}
      </div>
      <div class="passkey-info">
        <div class="passkey-name">{{.Name}}</div>
        <div class="passkey-date">
          {{if .Bound}}
          å·²ç»‘å®š{{if not .Enabled}}ï¼ˆè¯¥æ–¹å¼å·²åœç”¨ï¼‰{{end}}
          {{else if .Enabled}}
          æœªç»‘å®š
          {{else}}
          æœªç»‘å®šï¼ˆç®¡ç†å‘˜å·²åœç”¨ï¼Œæš‚ä¸å¯ç»‘å®šï¼‰
          {{end}}
        </div>
      </div>
      {{if .Bound}}
      <form method="POST" action="/profile/identities/{{.Slug}}/unbind" style="display:flex;gap:.4rem;align-items:center;flex-wrap:wrap;justify-content:flex-end">
        <input type="hidden" name="csrf_token" value="{{$.CSRFToken}}">
        <button class="btn btn-danger btn-sm" type="submit"
          data-confirm="ç¡®å®šè¦è§£ç»‘ {{.Name}} å—ï¼Ÿè§£ç»‘åå°†ä¸èƒ½å†ç”¨è¯¥æ–¹å¼ç™»å½•ã€‚"
          data-confirm-title="ç¡®è®¤è§£ç»‘ç™»å½•æ–¹å¼"
          data-confirm-btn="ç¡®è®¤è§£ç»‘"
          data-confirm-icon="âš ">
          è§£ç»‘
        </button>
      </form>
      {{else if .Enabled}}
      <form method="POST" action="/profile/identities/{{.Slug}}/bind" style="display:flex;gap:.4rem;align-items:center;flex-wrap:wrap;justify-content:flex-end">
        <input type="hidden" name="csrf_token" value="{{$.CSRFToken}}">
        <button class="btn btn-primary btn-sm" type="submit"
          data-confirm="å°†è·³è½¬åˆ° {{.Name}} æˆæƒé¡µé¢å®Œæˆç»‘å®šã€‚æ˜¯å¦ç»§ç»­ï¼Ÿ"
          data-confirm-title="ç¡®è®¤ç»‘å®šç™»å½•æ–¹å¼"
          data-confirm-btn="ç»§ç»­"
          data-confirm-icon="ğŸ”—"
          data-confirm-danger="0">
          ç»‘å®š
        </button>
      </form>
      {{else}}
      <button class="btn btn-ghost btn-sm" type="button" disabled>æš‚ä¸å¯ç»‘å®š</button>
      {{end}}
    </div>
    {{end}}
    {{else}}
    <p style="font-size:.86rem;color:var(--text2)">ç®¡ç†å‘˜å°šæœªé…ç½®å¤–éƒ¨ç™»å½•æ–¹å¼ã€‚</p>
    {{end}}
    {{end}}
  </div>

  <form method="POST" action="/profile">
    <input type="hidden" name="csrf_token" value="{{$.CSRFToken}}">
    <div class="card" style="margin-bottom:1.5rem">
      <p class="form-panel-title">åŸºç¡€ä¿¡æ¯</p>
      <div class="form-group">
        <label class="form-label">æ˜¾ç¤ºåç§°</label>
        <input class="form-control" type="text" name="display_name" value="{{.DisplayName}}" required>
      </div>
      <div class="form-group">
        <label class="form-label">å¤´åƒåœ°å€ï¼ˆå¯é€‰ï¼‰</label>
        <input class="form-control" type="url" name="avatar_url" value="{{.AvatarURL}}" placeholder="è¯·è¾“å…¥å¤´åƒåœ°å€">
      </div>
      <hr style="border:none;border-top:1px solid rgba(0,0,0,0.07);margin:1rem 0">
      <p style="font-size:.85rem;color:var(--text2);margin-bottom:.8rem">ä¿®æ”¹å¯†ç ï¼ˆç•™ç©ºè¡¨ç¤ºä¸ä¿®æ”¹ï¼‰</p>
      <div class="form-group">
        <label class="form-label">å½“å‰å¯†ç </label>
        <input class="form-control" type="password" name="current_password" autocomplete="current-password">
      </div>
      <div class="form-group">
        <label class="form-label">æ–°å¯†ç ï¼ˆè‡³å°‘ 8 ä½ï¼‰</label>
        <input class="form-control" type="password" name="new_password" minlength="8" autocomplete="new-password">
      </div>
      <div class="form-group">
        <label class="form-label">ç¡®è®¤æ–°å¯†ç </label>
        <input class="form-control" type="password" name="confirm_password" autocomplete="new-password">
      </div>
      <button class="btn btn-primary" type="submit">ä¿å­˜èµ„æ–™</button>
    </div>
  </form>

  <div class="card" style="margin-bottom:1.5rem">
    <p class="form-panel-title">ä¸¤æ­¥éªŒè¯ï¼ˆåŠ¨æ€å£ä»¤ï¼‰</p>
    {{if .TOTPEnabled}}
    <p style="font-size:.9rem;color:var(--text2);margin-bottom:1rem">å½“å‰è´¦å·å·²å¯ç”¨åŠ¨æ€å£ä»¤ã€‚</p>
    <button class="btn btn-danger btn-sm" data-modal="totp-disable-modal" type="button">å…³é—­åŒé‡éªŒè¯</button>
    {{else}}
    <p style="font-size:.9rem;color:var(--text2);margin-bottom:1rem">å»ºè®®å¯ç”¨åŠ¨æ€å£ä»¤ï¼Œæå‡è´¦æˆ·å®‰å…¨ã€‚</p>
    <button class="btn btn-primary btn-sm" data-modal="totp-setup-modal" type="button">å¯ç”¨åŒé‡éªŒè¯</button>
    {{end}}
  </div>

  <div class="card" style="margin-bottom:1.5rem">
    <p class="form-panel-title">é€šè¡Œå¯†é’¥</p>
    <p style="font-size:.88rem;color:var(--text2);margin-bottom:1rem">
      ä½¿ç”¨æŒ‡çº¹ã€é¢å®¹è¯†åˆ«æˆ–å®‰å…¨å¯†é’¥ç™»å½•ã€‚
    </p>

    {{with $.Data}}
    {{if index . "Passkeys"}}
    {{$passkeyCount := index . "PasskeyCount"}}
    {{$hasPassword := index . "HasPassword"}}
    {{$hasTOTP := $.CurrentUser.TOTPEnabled}}
    {{$canDeleteWithoutPassword := and (not $hasPassword) $hasTOTP (gt $passkeyCount 1)}}
    {{$allowDelete := or $hasPassword $canDeleteWithoutPassword}}
    {{range index . "Passkeys"}}
    <div class="passkey-item">
      <div class="passkey-icon">ğŸ”‘</div>
      <div class="passkey-info">
        <div class="passkey-name">{{.Name}}</div>
        <div class="passkey-date">æ³¨å†Œäº {{.CreatedAt.Format "2006-01-02"}}</div>
      </div>
      {{if not $allowDelete}}
      <button class="btn btn-danger btn-sm" type="button" disabled
        title="{{if not $hasPassword}}{{if le $passkeyCount 1}}æ— å¯†ç è´¦æˆ·å¿…é¡»è‡³å°‘ä¿ç•™ä¸€ä¸ªé€šè¡Œå¯†é’¥{{else}}åˆ é™¤é€šè¡Œå¯†é’¥å‰è¯·å…ˆå¯ç”¨åŠ¨æ€å£ä»¤æˆ–è®¾ç½®å¯†ç {{end}}{{else}}å½“å‰ä¸å¯åˆ é™¤{{end}}">åˆ é™¤</button>
      {{else}}
      <form method="POST" action="/profile/passkey/{{.ID}}/delete">
        <input type="hidden" name="csrf_token" value="{{$.CSRFToken}}">
        <input type="hidden" name="current_password" value="">
        <input type="hidden" name="totp_code" value="">
        <button class="btn btn-danger btn-sm" type="submit"
          onclick="return confirmPasskeyDelete(this.form, {{if $hasPassword}}true{{else}}false{{end}}, {{if $hasTOTP}}true{{else}}false{{end}}, {{if and (eq $passkeyCount 1) $hasPassword (not $hasTOTP)}}true{{else}}false{{end}})">åˆ é™¤</button>
      </form>
      {{end}}
    </div>
    {{end}}
    {{else}}
    <p style="font-size:.86rem;color:var(--text2);margin-bottom:.7rem">å°šæœªæ³¨å†Œé€šè¡Œå¯†é’¥ã€‚</p>
    {{end}}

    <div style="display:flex;gap:.6rem;align-items:center;margin-top:.8rem;flex-wrap:wrap">
      <input class="form-control" type="text" id="passkey-name" placeholder="é€šè¡Œå¯†é’¥åç§°ï¼ˆå¯é€‰ï¼‰" style="flex:1">
      <button id="passkey-register-btn" class="btn btn-ghost btn-sm" type="button">æ³¨å†Œé€šè¡Œå¯†é’¥</button>
    </div>
    <div id="passkey-register-msg"></div>
    {{end}}
  </div>

  {{with $.Data}}
  {{$hasPassword := index . "HasPassword"}}
  {{$passkeyCount := index . "PasskeyCount"}}
  {{if and $hasPassword (gt $passkeyCount 0)}}
  <div class="card" style="margin-bottom:1.5rem">
    <p class="form-panel-title" style="color:#dc2626">åˆ é™¤å¯†ç </p>
    <p style="font-size:.88rem;color:var(--text2);margin-bottom:1rem">
      åˆ é™¤å¯†ç åï¼Œä½ åªèƒ½ä½¿ç”¨é€šè¡Œå¯†é’¥ç™»å½•ã€‚
    </p>
    <form method="POST" action="/profile/delete-password">
      <input type="hidden" name="csrf_token" value="{{$.CSRFToken}}">
      <button class="btn btn-danger btn-sm" type="submit"
        onclick="return confirm('æ˜¯å¦ç«‹å³åˆ é™¤å¯†ç ï¼Ÿåˆ é™¤åå¿…é¡»ä½¿ç”¨é€šè¡Œå¯†é’¥ç™»å½•ã€‚')">åˆ é™¤å¯†ç </button>
    </form>
  </div>
  {{end}}
  {{end}}
  {{end}}
</div>

{{if .CurrentUser}}
<div id="totp-setup-modal" class="modal">
  <div class="modal-box">
    <div class="modal-close" data-modal-close>&times;</div>
    <h3 style="margin:0 0 .6rem;font-size:1.1rem">å¯ç”¨åŠ¨æ€å£ä»¤</h3>

    {{with .Data}}
    {{if index . "PendingSecret"}}
    <p style="font-size:.88rem;color:var(--text2);margin-bottom:.8rem">è¯·ä½¿ç”¨è®¤è¯å™¨æ‰«æäºŒç»´ç ï¼Œç„¶åè¾“å…¥ 6 ä½éªŒè¯ç å®Œæˆå¯ç”¨ã€‚</p>
    <div style="text-align:center;margin:.8rem 0 1rem">
      <img src="/profile/2fa/qr" alt="åŠ¨æ€å£ä»¤äºŒç»´ç " width="200" height="200">
    </div>
    <details style="margin-bottom:.8rem">
      <summary style="cursor:pointer;font-size:.82rem;color:var(--text2)">æ˜¾ç¤ºæ‰‹åŠ¨è¾“å…¥å¯†é’¥</summary>
      <div style="margin-top:.5rem;font-family:monospace;font-size:.82rem;word-break:break-all">{{index . "PendingSecret"}}</div>
    </details>
    <form method="POST" action="/profile/2fa/enable">
      <input type="hidden" name="csrf_token" value="{{$.CSRFToken}}">
      <div class="form-group">
        <label class="form-label">è®¤è¯å™¨éªŒè¯ç </label>
        <input class="form-control" type="text" name="totp_code" placeholder="123456" required inputmode="numeric" pattern="[0-9]{6}">
      </div>
      <button class="btn btn-primary" type="submit">å¯ç”¨åŒé‡éªŒè¯</button>
    </form>
    <div class="divider">é‡æ–°ç”Ÿæˆ</div>
    <form method="POST" action="/profile/2fa/start">
      <input type="hidden" name="csrf_token" value="{{$.CSRFToken}}">
      <button class="btn btn-ghost btn-sm" type="submit">ç”Ÿæˆæ–°å¯†é’¥</button>
    </form>
    {{else}}
    <p style="font-size:.88rem;color:var(--text2);margin-bottom:1.2rem">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ç”ŸæˆåŠ¨æ€å£ä»¤å¯†é’¥å¹¶ç»§ç»­è®¾ç½®ã€‚</p>
    <form method="POST" action="/profile/2fa/start">
      <input type="hidden" name="csrf_token" value="{{$.CSRFToken}}">
      <button class="btn btn-primary" type="submit">ç”ŸæˆåŠ¨æ€å£ä»¤å¯†é’¥</button>
    </form>
    {{end}}
    {{end}}
  </div>
</div>

{{if .CurrentUser.TOTPEnabled}}
<div id="totp-disable-modal" class="modal">
  <div class="modal-box">
    <div class="modal-close" data-modal-close>&times;</div>
    <h3 style="margin:0 0 .6rem;font-size:1.1rem;color:#dc2626">å…³é—­åŒé‡éªŒè¯</h3>
    <p style="font-size:.88rem;color:var(--text2);margin-bottom:1rem">
      ä¸ºä¿éšœå®‰å…¨ï¼Œè¯·æä¾›å½“å‰å¯†ç æˆ–æœ‰æ•ˆçš„åŠ¨æ€å£ä»¤éªŒè¯ç ã€‚
    </p>
    <form method="POST" action="/profile/2fa/disable">
      <input type="hidden" name="csrf_token" value="{{$.CSRFToken}}">
      <div class="form-group">
        <label class="form-label">å½“å‰å¯†ç ï¼ˆè‹¥å¡«å†™äº†éªŒè¯ç å¯ç•™ç©ºï¼‰</label>
        <input class="form-control" type="password" name="current_password">
      </div>
      <div class="form-group">
        <label class="form-label">åŠ¨æ€å£ä»¤éªŒè¯ç ï¼ˆè‹¥å¡«å†™äº†å¯†ç å¯ç•™ç©ºï¼‰</label>
        <input class="form-control" type="text" name="totp_code" inputmode="numeric" pattern="[0-9]{6}" placeholder="123456">
      </div>
      <button class="btn btn-danger" type="submit">å…³é—­åŒé‡éªŒè¯</button>
    </form>
  </div>
</div>
{{end}}
{{end}}

<script>
function confirmPasskeyDelete(form, hasPassword, hasTOTP, showWeakWarning) {
  if (showWeakWarning) {
    if (!confirm('åˆ é™¤æ­¤é€šè¡Œå¯†é’¥åå¯èƒ½åªå‰©å¯†ç ç™»å½•ï¼Œå®‰å…¨æ€§æ›´å¼±ã€‚æ˜¯å¦ç»§ç»­ï¼Ÿ')) {
      return false;
    }
  } else if (!confirm('ç¡®å®šåˆ é™¤æ­¤é€šè¡Œå¯†é’¥å—ï¼Ÿ')) {
    return false;
  }

  var password = '';
  var totp = '';
  if (hasPassword) {
    password = prompt('è¯·è¾“å…¥å½“å‰å¯†ç ã€‚ç•™ç©ºåˆ™æ”¹ä¸ºè¾“å…¥åŠ¨æ€å£ä»¤éªŒè¯ç ã€‚') || '';
  }
  if ((!password || password.trim() === '') && hasTOTP) {
    totp = prompt('è¯·è¾“å…¥ 6 ä½åŠ¨æ€å£ä»¤éªŒè¯ç ã€‚') || '';
  }
  if (hasPassword && (!password || password.trim() === '') && (!hasTOTP || !totp || totp.trim() === '')) {
    alert('åˆ é™¤é€šè¡Œå¯†é’¥éœ€è¦æä¾›å½“å‰å¯†ç æˆ–åŠ¨æ€å£ä»¤éªŒè¯ç ã€‚');
    return false;
  }
  if (!hasPassword && hasTOTP && (!totp || totp.trim() === '')) {
    alert('æ— å¯†ç è´¦æˆ·åˆ é™¤é€šè¡Œå¯†é’¥æ—¶å¿…é¡»æä¾›åŠ¨æ€å£ä»¤éªŒè¯ç ã€‚');
    return false;
  }

  var p = form.querySelector('input[name="current_password"]');
  var t = form.querySelector('input[name="totp_code"]');
  if (p) p.value = password.trim();
  if (t) t.value = totp.trim();
  return true;
}
</script>
{{end}}
