{{template "base" .}}

{{define "content"}}
<div class="profile-page" style="margin-top:60px">
  <h1 style="font-size:1.6rem;font-weight:800;margin-bottom:.3rem">ä¸ªäººèµ„æ–™</h1>
  <p style="color:var(--text2);margin-bottom:1.5rem">ç®¡ç†è´¦æˆ·ä¿¡æ¯ä¸å®‰å…¨è®¾ç½®</p>

  {{if .Flash}}
  <div class="flash {{if .IsError}}flash-err{{else}}flash-ok{{end}}">{{.Flash}}</div>
  {{end}}

  {{with .CurrentUser}}
  {{/* Basic info card */}}
  <div class="card" style="margin-bottom:1.5rem">
    <p style="font-size:.8rem;color:var(--text2);margin-bottom:1rem">è´¦æˆ·æ¦‚è§ˆ</p>
    <p style="font-size:.9rem;margin-bottom:.3rem">é‚®ç®±ï¼š<strong>{{.Email}}</strong></p>
    <p style="font-size:.9rem;margin-bottom:.3rem">è§’è‰²ï¼š<strong>{{.RoleLabel}}</strong></p>
    <p style="font-size:.9rem;margin-bottom:.3rem">
      2FAï¼š<strong>{{if .TOTPEnabled}}å·²å¯ç”¨{{else}}æœªå¯ç”¨{{end}}</strong>
    </p>
  </div>

  {{/* Profile edit form */}}
  <form method="POST" action="/profile">
    <input type="hidden" name="csrf_token" value="{{$.CSRFToken}}">
    <div class="card" style="margin-bottom:1.5rem">
      <p class="form-panel-title">åŸºç¡€ä¿¡æ¯</p>
      <div class="form-group">
        <label class="form-label">æ˜¾ç¤ºåç§°</label>
        <input class="form-control" type="text" name="display_name" value="{{.DisplayName}}" required>
      </div>
      <div class="form-group">
        <label class="form-label">å¤´åƒ URLï¼ˆå¯é€‰ï¼‰</label>
        <input class="form-control" type="url" name="avatar_url" value="{{.AvatarURL}}" placeholder="https://...">
      </div>
      <hr style="border:none;border-top:1px solid rgba(0,0,0,0.07);margin:1rem 0">
      <p style="font-size:.85rem;color:var(--text2);margin-bottom:.8rem">ä¿®æ”¹å¯†ç ï¼ˆç•™ç©ºè¡¨ç¤ºä¸ä¿®æ”¹ï¼‰</p>
      <div class="form-group">
        <label class="form-label">å½“å‰å¯†ç </label>
        <input class="form-control" type="password" name="current_password" autocomplete="current-password">
      </div>
      <div class="form-group">
        <label class="form-label">æ–°å¯†ç ï¼ˆè‡³å°‘ 8 ä½ï¼‰</label>
        <input class="form-control" type="password" name="new_password" minlength="8" autocomplete="new-password">
      </div>
      <div class="form-group">
        <label class="form-label">ç¡®è®¤æ–°å¯†ç </label>
        <input class="form-control" type="password" name="confirm_password" autocomplete="new-password">
      </div>
      <button class="btn btn-primary" type="submit">ä¿å­˜èµ„æ–™</button>
    </div>
  </form>

  {{/* â”€â”€ 2FA card â”€â”€ */}}
  <div class="card" style="margin-bottom:1.5rem">
    <p class="form-panel-title">ä¸¤æ­¥éªŒè¯ï¼ˆTOTPï¼‰</p>

    {{if .TOTPEnabled}}
    <p style="font-size:.9rem;color:var(--text2);margin-bottom:1rem">å·²å¯ç”¨ã€‚ç™»å½•æ—¶éœ€è¦è¾“å…¥è®¤è¯å™¨éªŒè¯ç ã€‚</p>
    <button class="btn btn-danger btn-sm" data-modal="totp-disable-modal" type="button">å…³é—­ 2FA</button>
    {{else}}
    <p style="font-size:.9rem;color:var(--text2);margin-bottom:1rem">å¯ç”¨åï¼Œç™»å½•å°†éœ€è¦å¯†ç  + è®¤è¯å™¨éªŒè¯ç ã€‚</p>
    <button class="btn btn-primary btn-sm" data-modal="totp-setup-modal" type="button">è®¾ç½® 2FA</button>
    {{end}}
  </div>

  {{/* â”€â”€ Passkey card â”€â”€ */}}
  <div class="card" style="margin-bottom:1.5rem">
    <p class="form-panel-title">Passkeyï¼ˆé€šè¡Œå¯†é’¥ï¼‰</p>
    <p style="font-size:.88rem;color:var(--text2);margin-bottom:1rem">
      ä½¿ç”¨æŒ‡çº¹ã€é¢å®¹ ID æˆ–å®‰å…¨å¯†é’¥ç™»å½•ï¼Œæ— éœ€æ¯æ¬¡è¾“å…¥å¯†ç éªŒè¯ç ã€‚
    </p>

    {{/* Existing passkeys - need passkeys from Data */}}
    {{with $.Data}}
    {{if index . "Passkeys"}}
    {{range index . "Passkeys"}}
    <div class="passkey-item">
      <div class="passkey-icon">ğŸ”‘</div>
      <div class="passkey-info">
        <div class="passkey-name">{{.Name}}</div>
        <div class="passkey-date">æ³¨å†Œäº {{.CreatedAt.Format "2006-01-02"}}</div>
      </div>
      <form method="POST" action="/profile/passkey/{{.ID}}/delete">
        <input type="hidden" name="csrf_token" value="{{$.CSRFToken}}">
        <button class="btn btn-danger btn-sm" type="submit">åˆ é™¤</button>
      </form>
    </div>
    {{end}}
    {{end}}
    {{end}}

    <div style="margin-top:.8rem">
      <div class="form-group" style="flex-direction:row;align-items:center;gap:.6rem;margin-bottom:.6rem">
        <input class="form-control" type="text" id="passkey-name" placeholder="ä¸ºè¿™ä¸ª Passkey èµ·ä¸ªåå­—ï¼ˆå¯é€‰ï¼‰" style="flex:1">
        <button id="passkey-register-btn" class="btn btn-ghost btn-sm" type="button">æ³¨å†Œ Passkey</button>
      </div>
      <div id="passkey-register-msg"></div>
    </div>
  </div>
  {{end}}
</div>

{{/* â”€â”€ TOTP Setup Modal â”€â”€ */}}
{{if .CurrentUser}}
<div id="totp-setup-modal" class="modal">
  <div class="modal-box">
    <div class="modal-header">
      <span class="modal-title">è®¾ç½®ä¸¤æ­¥éªŒè¯</span>
      <button class="modal-close" type="button">âœ•</button>
    </div>

    {{with .Data}}
    {{if index . "PendingSecret"}}
    {{/* Server has a pending secret - show QR + verify */}}
    <div id="totp-pending-marker" style="display:none"></div>
    <p style="font-size:.88rem;color:var(--text2);margin-bottom:1rem">
      è¯·ä½¿ç”¨è®¤è¯å™¨åº”ç”¨ï¼ˆå¦‚ Google Authenticatorã€Aegisï¼‰æ‰«æä¸‹æ–¹äºŒç»´ç ï¼Œç„¶åè¾“å…¥éªŒè¯ç å®Œæˆå¯ç”¨ã€‚
    </p>
    <div class="qr-block">
      <img src="/profile/2fa/qr" alt="TOTP QR Code" width="200" height="200">
      <div class="qr-secret">å¯†é’¥ï¼ˆæ‰‹åŠ¨è¾“å…¥ï¼‰ï¼š{{index . "PendingSecret"}}</div>
    </div>
    <form method="POST" action="/profile/2fa/enable" style="margin-top:1rem">
      <input type="hidden" name="csrf_token" value="{{$.CSRFToken}}">
      <div class="form-group">
        <label class="form-label">è®¤è¯å™¨éªŒè¯ç </label>
        <input class="form-control" type="text" name="totp_code" inputmode="numeric"
          autocomplete="one-time-code" placeholder="123456" required autofocus>
      </div>
      <div style="display:flex;gap:.8rem">
        <button class="btn btn-primary" type="submit">ç¡®è®¤å¯ç”¨</button>
      </div>
    </form>
    <div class="divider">é‡æ–°ç”Ÿæˆå¯†é’¥</div>
    <form method="POST" action="/profile/2fa/start">
      <input type="hidden" name="csrf_token" value="{{$.CSRFToken}}">
      <div class="form-group">
        <label class="form-label">å½“å‰å¯†ç </label>
        <input class="form-control" type="password" name="current_password" required>
      </div>
      <button class="btn btn-ghost btn-sm" type="submit">é‡æ–°ç”Ÿæˆ</button>
    </form>
    {{else}}
    {{/* No pending secret - show password form to start */}}
    <p style="font-size:.88rem;color:var(--text2);margin-bottom:1.2rem">
      è¾“å…¥å½“å‰å¯†ç ä»¥ç”Ÿæˆ 2FA å¯†é’¥ã€‚
    </p>
    <form method="POST" action="/profile/2fa/start">
      <input type="hidden" name="csrf_token" value="{{$.CSRFToken}}">
      <div class="form-group">
        <label class="form-label">å½“å‰å¯†ç </label>
        <input class="form-control" type="password" name="current_password" required autofocus>
      </div>
      <button class="btn btn-primary" type="submit">ç”Ÿæˆ 2FA å¯†é’¥</button>
    </form>
    {{end}}
    {{else}}
    {{/* .Data is nil (no TOTP pending) */}}
    <p style="font-size:.88rem;color:var(--text2);margin-bottom:1.2rem">
      è¾“å…¥å½“å‰å¯†ç ä»¥ç”Ÿæˆ 2FA å¯†é’¥ã€‚
    </p>
    <form method="POST" action="/profile/2fa/start">
      <input type="hidden" name="csrf_token" value="{{$.CSRFToken}}">
      <div class="form-group">
        <label class="form-label">å½“å‰å¯†ç </label>
        <input class="form-control" type="password" name="current_password" required autofocus>
      </div>
      <button class="btn btn-primary" type="submit">ç”Ÿæˆ 2FA å¯†é’¥</button>
    </form>
    {{end}}
  </div>
</div>

{{/* â”€â”€ TOTP Disable Modal â”€â”€ */}}
{{if .CurrentUser.TOTPEnabled}}
<div id="totp-disable-modal" class="modal">
  <div class="modal-box">
    <div class="modal-header">
      <span class="modal-title">å…³é—­ä¸¤æ­¥éªŒè¯</span>
      <button class="modal-close" type="button">âœ•</button>
    </div>
    <p style="font-size:.88rem;color:var(--text2);margin-bottom:1.2rem">
      å…³é—­åï¼Œç™»å½•æ—¶å°†ä¸å†éœ€è¦è®¤è¯å™¨éªŒè¯ç ã€‚
    </p>
    <form method="POST" action="/profile/2fa/disable">
      <input type="hidden" name="csrf_token" value="{{$.CSRFToken}}">
      <div class="form-group">
        <label class="form-label">å½“å‰å¯†ç </label>
        <input class="form-control" type="password" name="current_password" required>
      </div>
      <div class="form-group">
        <label class="form-label">è®¤è¯å™¨éªŒè¯ç </label>
        <input class="form-control" type="text" name="totp_code" inputmode="numeric"
          autocomplete="one-time-code" placeholder="123456" required>
      </div>
      <button class="btn btn-danger" type="submit">ç¡®è®¤å…³é—­ 2FA</button>
    </form>
  </div>
</div>
{{end}}
{{end}}
{{end}}
