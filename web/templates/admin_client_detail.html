{{template "base" .}}

{{define "content"}}
<div class="panel-wrap">
  <aside class="sidebar">
    <div class="sidebar-section">
      <div class="sidebar-title">ç®¡ç†å¯¼èˆª</div>
      {{if .CurrentUser.IsAdmin}}
      <a class="sidebar-link" href="/admin">æ¦‚è§ˆ</a>
      <a class="sidebar-link" href="/admin/users">ç”¨æˆ·</a>
      {{end}}
      <a class="sidebar-link" href="/admin/groups">åˆ†ç»„</a>
      <a class="sidebar-link active" href="/admin/clients">åº”ç”¨</a>
      {{if .CurrentUser.IsAdmin}}
      <a class="sidebar-link" href="/admin/providers">ç™»å½•æ–¹å¼</a>
      <a class="sidebar-link" href="/admin/roles">è§’è‰²</a>
      <a class="sidebar-link" href="/admin/announcements">å…¬å‘Š</a>
      <a class="sidebar-link" href="/admin/settings">è®¾ç½®</a>
      {{end}}
    </div>
    <div class="sidebar-section">
      <div class="sidebar-title">å¿«é€Ÿå…¥å£</div>
      <a class="sidebar-link" href="/">è¿”å›é¦–é¡µ</a>
      <a class="sidebar-link" href="/profile">ä¸ªäººèµ„æ–™</a>
    </div>
  </aside>

  <main class="panel-content">
    {{with .Data}}
    {{$client := index . "Client"}}
    {{$ann    := index . "Announcement"}}

    <div style="display:flex;align-items:center;gap:.8rem;margin-bottom:.5rem">
      <a href="/admin/clients" style="color:var(--text2);font-size:.9rem">â† åº”ç”¨åˆ—è¡¨</a>
    </div>

    {{if $.Flash}}
    <div class="flash {{if $.IsError}}flash-err{{else}}flash-ok{{end}}">{{$.Flash}}</div>
    {{end}}

    <h1 class="panel-title">{{$client.Name}}</h1>

    {{/* â”€â”€ Client info â”€â”€ */}}
    <div class="detail-section">
      <div class="detail-section-title">åŸºæœ¬ä¿¡æ¯</div>
      <div class="detail-row">
        <div class="detail-key">Client ID</div>
        <div class="detail-val mono">{{$client.ClientID}}</div>
      </div>
      <div class="detail-row">
        <div class="detail-key">åç§°</div>
        <div class="detail-val">{{$client.Name}}</div>
      </div>
      <div class="detail-row">
        <div class="detail-key">æè¿°</div>
        <div class="detail-val">{{if $client.Description}}{{$client.Description}}{{else}}<span style="color:var(--text2)">ï¼ˆæ— ï¼‰</span>{{end}}</div>
      </div>
      <div class="detail-row">
        <div class="detail-key">Scopes</div>
        <div class="detail-val">{{range $client.Scopes}}<span class="proj-tag">{{.}}</span> {{end}}</div>
      </div>
      <div class="detail-row">
        <div class="detail-key">Redirect URIs</div>
        <div class="detail-val">{{range $client.RedirectURIs}}<div class="mono" style="font-size:.82rem">{{.}}</div>{{end}}</div>
      </div>
      <div class="detail-row">
        <div class="detail-key">åˆ›å»ºæ—¶é—´</div>
        <div class="detail-val">{{$client.CreatedAt.Format "2006-01-02 15:04"}}</div>
      </div>
    </div>

    {{/* â”€â”€ Integration guide â”€â”€ */}}
    <details class="detail-section" style="cursor:pointer">
      <summary style="font-weight:600;font-size:.95rem;list-style:none;display:flex;align-items:center;justify-content:space-between">
        æ¥å…¥æŒ‡å— <span style="font-size:.8rem;color:var(--text2);font-weight:400">ï¼ˆå¡«å†™åˆ°ç¬¬ä¸‰æ–¹æœåŠ¡çš„ OIDC / SSO é…ç½®é¡µï¼‰â–¾</span>
      </summary>

      <p style="font-size:.82rem;color:var(--text2);margin:.8rem 0 1rem">
        å°†æœ¬æœåŠ¡ä½œä¸º OIDC èº«ä»½æä¾›å•†ï¼ˆIdPï¼‰æ¥å…¥ Cloudflare Accessã€Authentikã€Grafanaã€GitLab ç­‰ç³»ç»Ÿæ—¶ï¼ŒæŒ‰ä¸‹è¡¨å¡«å†™ã€‚
        æ”¯æŒè‡ªåŠ¨å‘ç°çš„ç³»ç»Ÿåªéœ€å¡«å†™ <strong>å‘ç°æ–‡æ¡£ URL</strong> å³å¯ï¼Œå…¶ä½™ URL ä¼šè‡ªåŠ¨è·å–ã€‚
      </p>

      <table class="data-table" style="margin-bottom:1rem">
        <thead>
          <tr><th style="width:36%">å­—æ®µ</th><th>å¡«å†™å€¼</th></tr>
        </thead>
        <tbody>
          <tr>
            <td>å‘ç°æ–‡æ¡£ URL<br><span style="font-size:.75rem;color:var(--text2)">OIDC Discovery / Well-Known</span></td>
            <td><code class="mono">{{$.Issuer}}/.well-known/openid-configuration</code></td>
          </tr>
          <tr>
            <td>èº«ä»½éªŒè¯ URL<br><span style="font-size:.75rem;color:var(--text2)">Authorization Endpoint</span></td>
            <td><code class="mono">{{$.Issuer}}/oauth2/authorize</code></td>
          </tr>
          <tr>
            <td>ä»¤ç‰Œ URL<br><span style="font-size:.75rem;color:var(--text2)">Token Endpoint</span></td>
            <td><code class="mono">{{$.Issuer}}/oauth2/token</code></td>
          </tr>
          <tr>
            <td>è¯ä¹¦ URL<br><span style="font-size:.75rem;color:var(--text2)">JWKS URI / Certs Endpoint</span></td>
            <td><code class="mono">{{$.Issuer}}/.well-known/jwks.json</code></td>
          </tr>
          <tr>
            <td>Client ID</td>
            <td><code class="mono">{{$client.ClientID}}</code></td>
          </tr>
          <tr>
            <td>Client Secret</td>
            <td><span style="color:var(--text2);font-size:.85rem">åˆ›å»ºæ—¶ä¸€æ¬¡æ€§æ˜¾ç¤ºï¼›å¦‚å·²ä¸¢å¤±è¯·é‡ç½®</span></td>
          </tr>
          <tr>
            <td>PKCE<br><span style="font-size:.75rem;color:var(--text2)">Code Challenge Method</span></td>
            <td><code class="mono">S256</code> <span style="font-size:.82rem;color:var(--text2)">ï¼ˆå·²æ”¯æŒï¼Œæ¨èå¼€å¯ï¼‰</span></td>
          </tr>
          <tr>
            <td>SCIM</td>
            <td><span style="color:var(--text2);font-size:.85rem">ä¸æ”¯æŒï¼Œä¿æŒå…³é—­</span></td>
          </tr>
          <tr>
            <td>ç”µå­é‚®ä»¶å£°æ˜<br><span style="font-size:.75rem;color:var(--text2)">Email Claim</span></td>
            <td><code class="mono">email</code></td>
          </tr>
          <tr>
            <td>OIDC èŒƒå›´<br><span style="font-size:.75rem;color:var(--text2)">Scopes</span></td>
            <td><code class="mono">openid email profile</code></td>
          </tr>
          <tr>
            <td>å¯ç”¨è‡ªå®šä¹‰å£°æ˜<br><span style="font-size:.75rem;color:var(--text2)">Custom Claims from id_token</span></td>
            <td>
              <code class="mono">role</code> â€” ç”¨æˆ·è§’è‰²ï¼ˆuser / member / adminï¼‰<br>
              <code class="mono">name</code> â€” æ˜¾ç¤ºåç§°ï¼ˆéœ€è¦ profile scopeï¼‰<br>
              <code class="mono">picture</code> â€” å¤´åƒ URLï¼ˆéœ€è¦ profile scopeï¼‰
            </td>
          </tr>
        </tbody>
      </table>

      <div style="background:#f8fafc;border:1px solid var(--glass-b);border-radius:10px;padding:.9rem 1rem;font-size:.82rem;color:var(--text2)">
        <strong style="color:var(--text)">Cloudflare Access å¡«å†™ç¤ºä¾‹ï¼š</strong><br>
        èº«ä»½éªŒè¯ URL â†’ <code>{{$.Issuer}}/oauth2/authorize</code><br>
        ä»¤ç‰Œ URL â†’ <code>{{$.Issuer}}/oauth2/token</code><br>
        è¯ä¹¦ URL â†’ <code>{{$.Issuer}}/.well-known/jwks.json</code><br>
        PKCE â†’ <strong>å¼€å¯</strong>ï¼ˆæœºå¯†å®¢æˆ·ç«¯ä¹Ÿæ”¯æŒï¼‰&emsp;
        SCIM â†’ <strong>å…³é—­</strong>&emsp;
        ç”µå­é‚®ä»¶å£°æ˜ â†’ <code>email</code><br>
        OIDC èŒƒå›´ â†’ <code>openid email profile</code>ï¼ˆåœ¨åŸæœ‰åŸºç¡€ä¸Šè¿½åŠ ï¼‰
      </div>
    </details>

    {{/* â”€â”€ Edit form â”€â”€ */}}
    <div class="detail-section">
      <div class="detail-section-title">ç¼–è¾‘ä¿¡æ¯</div>
      <form method="POST" action="/admin/clients/{{$client.ID}}/update">
        <input type="hidden" name="csrf_token" value="{{$.CSRFToken}}">
        <div class="form-group">
          <label class="form-label">åº”ç”¨åç§°</label>
          <input class="form-control" type="text" name="name" value="{{$client.Name}}" required>
        </div>
        <div class="form-group">
          <label class="form-label">æè¿°</label>
          <input class="form-control" type="text" name="description" value="{{$client.Description}}">
        </div>
        <div class="form-group">
          <label class="form-label">Redirect URIsï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰</label>
          <textarea class="form-control" name="redirect_uris" rows="4">{{range $client.RedirectURIs}}{{.}}
{{end}}</textarea>
        </div>
        <div class="form-group">
          <label class="form-label">Scopesï¼ˆç©ºæ ¼åˆ†éš”ï¼‰</label>
          <input class="form-control" type="text" name="scopes" value="{{range $client.Scopes}}{{.}} {{end}}">
        </div>
        <div class="form-group">
          <label class="form-label">åŸºç¡€è®¿é—®æƒé™</label>
          <select class="form-control" name="base_access">
            <option value="legacy" {{if eq $client.BaseAccess "legacy"}}selected{{end}}>å…¼å®¹æ¨¡å¼ï¼ˆæœ‰åˆ†ç»„åˆ™ä»…æŒ‰åˆ†ç»„ï¼Œæ— åˆ†ç»„åˆ™å…¨éƒ¨å¯è®¿é—®ï¼‰</option>
            <option value="user" {{if eq $client.BaseAccess "user"}}selected{{end}}>æ‰€æœ‰å·²ç™»å½•ç”¨æˆ·</option>
            <option value="member" {{if eq $client.BaseAccess "member"}}selected{{end}}>member åŠä»¥ä¸Š</option>
            <option value="admin" {{if eq $client.BaseAccess "admin"}}selected{{end}}>ä»… admin</option>
            <option value="none" {{if eq $client.BaseAccess "none"}}selected{{end}}>ä¸å¯ç”¨åŸºç¡€æƒé™ï¼ˆä»…åˆ†ç»„ï¼‰</option>
          </select>
          <span style="font-size:.78rem;color:var(--text2)">
            è®¿é—®è§„åˆ™ä¸ºã€ŒåŸºç¡€è®¿é—®æƒé™ OR ä»»æ„å‘½ä¸­ä¸€ä¸ªåˆ†ç»„ã€ã€‚
          </span>
        </div>
        <div class="form-group">
          <label class="form-label">å¯è®¿é—®åˆ†ç»„ï¼ˆç©ºæ ¼åˆ†éš”ï¼‰</label>
          <input class="form-control" type="text" name="allowed_groups"
            value="{{range $client.AllowedGroups}}{{.}} {{end}}"
            placeholder="member admin my-group">
          <span style="font-size:.78rem;color:var(--text2)">
            å†…ç½®åˆ†ç»„ï¼š<code>admin</code>ï¼ˆç®¡ç†å‘˜ï¼‰ã€<code>member</code>ï¼ˆæˆå‘˜åŠä»¥ä¸Šï¼‰ã€<code>user</code>ï¼ˆæ‰€æœ‰ç™»å½•ç”¨æˆ·ï¼‰ï¼›
            è‡ªå®šä¹‰åˆ†ç»„è§ã€Œåˆ†ç»„ç®¡ç†ã€é¡µã€‚å¤šä¸ªåˆ†ç»„æ»¡è¶³ä»»æ„ä¸€ä¸ªå³å¯ã€‚
          </span>
        </div>
        <button class="btn btn-primary btn-sm" type="submit">ä¿å­˜ä¿®æ”¹</button>
      </form>
    </div>

    {{/* â”€â”€ Announcement â”€â”€ */}}
    <div class="detail-section">
      <div class="detail-section-title">åº”ç”¨å…¬å‘Š</div>
      <p style="font-size:.82rem;color:var(--text2);margin-bottom:.8rem">
        å…¬å‘Šå¯é€šè¿‡ <code class="mono">/api/announcement/{{$client.ClientID}}</code> å…¬å¼€è®¿é—®ã€‚
      </p>
      <form method="POST" action="/admin/announcements/{{$client.ClientID}}/save">
        <input type="hidden" name="csrf_token" value="{{$.CSRFToken}}">
        <div class="form-group">
          <textarea class="form-control" name="content" rows="3" placeholder="å…¬å‘Šå†…å®¹ï¼ˆç•™ç©ºåˆ™æ¸…é™¤ï¼‰">{{$ann}}</textarea>
        </div>
        <button class="btn btn-ghost btn-sm" type="submit">ä¿å­˜å…¬å‘Š</button>
      </form>
    </div>

    {{/* â”€â”€ Danger zone â”€â”€ */}}
    <div class="detail-section" style="border-color:#fecaca">
      <div class="detail-section-title">å±é™©æ“ä½œ</div>
      <div style="display:flex;gap:.8rem;flex-wrap:wrap">
        <form method="POST" action="/admin/clients/{{$client.ID}}/reset-secret">
          <input type="hidden" name="csrf_token" value="{{$.CSRFToken}}">
          <button class="btn btn-ghost btn-sm" type="submit"
            data-confirm="é‡ç½®åæ—§ Secret ç«‹å³å¤±æ•ˆï¼Œæ‰€æœ‰ä½¿ç”¨æ—§ Secret çš„åº”ç”¨éƒ½éœ€è¦æ›´æ–°ã€‚" data-confirm-title="é‡ç½® Client Secret" data-confirm-icon="ğŸ”‘">é‡ç½® Client Secret</button>
        </form>
        <form method="POST" action="/admin/clients/{{$client.ID}}/delete">
          <input type="hidden" name="csrf_token" value="{{$.CSRFToken}}">
          <button class="btn btn-danger btn-sm" type="submit"
            data-confirm="åˆ é™¤åæ‰€æœ‰ä»¤ç‰Œå°†å¤±æ•ˆï¼Œæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚" data-confirm-title="åˆ é™¤åº”ç”¨" data-confirm-icon="âš ï¸">åˆ é™¤æ­¤åº”ç”¨</button>
        </form>
      </div>
    </div>

    {{end}}
  </main>
</div>
{{end}}
