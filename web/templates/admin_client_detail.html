{{template "base" .}}

{{define "content"}}
<div class="panel-wrap">
  <aside class="sidebar">
    <div class="sidebar-section">
      <div class="sidebar-title">ç®¡ç†å¯¼èˆª</div>
      {{if .CurrentUser.IsAdmin}}
      <a class="sidebar-link" href="/admin">æ¦‚è§ˆ</a>
      <a class="sidebar-link" href="/admin/users">ç”¨æˆ·</a>
      {{end}}
      <a class="sidebar-link" href="/admin/groups">åˆ†ç»„</a>
      <a class="sidebar-link active" href="/admin/clients">åº”ç”¨</a>
      {{if .CurrentUser.IsAdmin}}
      <a class="sidebar-link" href="/admin/providers">ç™»å½•æ–¹å¼</a>
      <a class="sidebar-link" href="/admin/roles">è§’è‰²</a>
      <a class="sidebar-link" href="/admin/announcements">å…¬å‘Š</a>
      <a class="sidebar-link" href="/admin/settings">è®¾ç½®</a>
      <a class="sidebar-link" href="/admin/audit-logs">å®¡è®¡æ—¥å¿—</a>
      {{end}}
    </div>
    <div class="sidebar-section">
      <div class="sidebar-title">å¿«é€Ÿå…¥å£</div>
      <a class="sidebar-link" href="/">è¿”å›é¦–é¡µ</a>
      <a class="sidebar-link" href="/profile">ä¸ªäººèµ„æ–™</a>
      <a class="sidebar-link" href="/member/projects">ç¤¾åŒºé¡¹ç›®</a>
    </div>
  </aside>

  <main class="panel-content">
    {{with .Data}}
    {{$client := index . "Client"}}
    {{$ann    := index . "Announcement"}}
    {{$allGroups := index . "AllGroups"}}
    {{$canManage := index . "CanManage"}}

    <div style="display:flex;align-items:center;gap:.8rem;margin-bottom:.5rem">
      <a href="/admin/clients" style="color:var(--text2);font-size:.9rem">â† åº”ç”¨åˆ—è¡¨</a>
    </div>

    {{if $.Flash}}
    <div class="flash {{if $.IsError}}flash-err{{else}}flash-ok{{end}}">{{$.Flash}}</div>
    {{end}}

    <h1 class="panel-title">{{$client.Name}}</h1>

    {{/* â”€â”€ åŸºç¡€ä¿¡æ¯ â”€â”€ */}}
    <div class="detail-section">
      <div class="detail-section-title">åŸºæœ¬ä¿¡æ¯</div>
      <div class="detail-row">
        <div class="detail-key">åº”ç”¨æ ‡è¯†</div>
        <div class="detail-val mono">{{$client.ClientID}}</div>
      </div>
      <div class="detail-row">
        <div class="detail-key">åç§°</div>
        <div class="detail-val">{{$client.Name}}</div>
      </div>
      <div class="detail-row">
        <div class="detail-key">æè¿°</div>
        <div class="detail-val">{{if $client.Description}}{{$client.Description}}{{else}}<span style="color:var(--text2)">ï¼ˆæ— ï¼‰</span>{{end}}</div>
      </div>
      <div class="detail-row">
        <div class="detail-key">æƒé™èŒƒå›´</div>
        <div class="detail-val">{{range $client.Scopes}}<span class="proj-tag">{{.}}</span> {{end}}</div>
      </div>
      <div class="detail-row">
        <div class="detail-key">å›è°ƒåœ°å€åˆ—è¡¨</div>
        <div class="detail-val">{{range $client.RedirectURIs}}<div class="mono" style="font-size:.82rem">{{.}}</div>{{end}}</div>
      </div>
      <div class="detail-row">
        <div class="detail-key">åˆ›å»ºæ—¶é—´</div>
        <div class="detail-val">{{$client.CreatedAt.Format "2006-01-02 15:04"}}</div>
      </div>
    </div>

    {{/* â”€â”€ æ¥å…¥æŒ‡å— â”€â”€ */}}
    <details class="detail-section" style="cursor:pointer">
      <summary style="font-weight:600;font-size:.95rem;list-style:none;display:flex;align-items:center;justify-content:space-between">
        æ¥å…¥æŒ‡å— <span style="font-size:.8rem;color:var(--text2);font-weight:400">ï¼ˆå¡«å†™åˆ°ç¬¬ä¸‰æ–¹å•ç‚¹ç™»å½•é…ç½®é¡µï¼‰â–¾</span>
      </summary>

      <p style="font-size:.82rem;color:var(--text2);margin:.8rem 0 1rem">
        å°†æœ¬æœåŠ¡ä½œä¸ºèº«ä»½æä¾›æ–¹æ¥å…¥ç¬¬ä¸‰æ–¹ç³»ç»Ÿæ—¶ï¼Œå¯æŒ‰ä¸‹è¡¨å¡«å†™ã€‚
        è‹¥å¯¹æ–¹æ”¯æŒè‡ªåŠ¨å‘ç°ï¼Œä»…éœ€å¡«å†™ <strong>Discovery Document URL</strong>ï¼Œå…¶ä½™åœ°å€ä¼šè‡ªåŠ¨è·å–ã€‚
      </p>

      <table class="data-table" style="margin-bottom:1rem">
        <thead>
          <tr><th style="width:36%">Field</th><th>Value</th></tr>
        </thead>
        <tbody>
          <tr>
            <td>Discovery Document URL<br><span style="font-size:.75rem;color:var(--text2)">Well-Known / Auto-discovery</span></td>
            <td><code class="mono">{{$.Issuer}}/.well-known/openid-configuration</code></td>
          </tr>
          <tr>
            <td>Authorization Endpoint<br><span style="font-size:.75rem;color:var(--text2)">authorization_endpoint</span></td>
            <td><code class="mono">{{$.Issuer}}/oauth2/authorize</code></td>
          </tr>
          <tr>
            <td>Token Endpoint<br><span style="font-size:.75rem;color:var(--text2)">token_endpoint</span></td>
            <td><code class="mono">{{$.Issuer}}/oauth2/token</code></td>
          </tr>
          <tr>
            <td>JWKS Endpoint<br><span style="font-size:.75rem;color:var(--text2)">jwks_uri</span></td>
            <td><code class="mono">{{$.Issuer}}/.well-known/jwks.json</code></td>
          </tr>
          <tr>
            <td>Client ID</td>
            <td><code class="mono">{{$client.ClientID}}</code></td>
          </tr>
          <tr>
            <td>Client Secret</td>
            <td><span style="color:var(--text2);font-size:.85rem">åˆ›å»ºæ—¶ä¸€æ¬¡æ€§æ˜¾ç¤ºï¼›å¦‚å·²ä¸¢å¤±è¯·é‡ç½®</span></td>
          </tr>
          <tr>
            <td>Code Challenge Method<br><span style="font-size:.75rem;color:var(--text2)">PKCE / code_challenge_method</span></td>
            <td><span style="font-size:.82rem;color:var(--text2)">ç³»ç»Ÿé»˜è®¤å¼€å¯æ¨èæ¨¡å¼</span></td>
          </tr>
          <tr>
            <td>Directory Sync</td>
            <td><span style="color:var(--text2);font-size:.85rem">ä¸æ”¯æŒï¼Œä¿æŒå…³é—­</span></td>
          </tr>
          <tr>
            <td>Email Field<br><span style="font-size:.75rem;color:var(--text2)">email claim / field name</span></td>
            <td><span style="font-size:.82rem;color:var(--text2)">ä½¿ç”¨ç³»ç»Ÿé»˜è®¤å­—æ®µ</span></td>
          </tr>
          <tr>
            <td>Scope<br><span style="font-size:.75rem;color:var(--text2)">requested scopes</span></td>
            <td><span style="font-size:.82rem;color:var(--text2)">é»˜è®¤æƒé™é¡¹ï¼ˆæ ¸å¿ƒç™»å½•ã€é‚®ç®±ã€èµ„æ–™ï¼‰</span></td>
          </tr>
          <tr>
            <td>Available Claims<br><span style="font-size:.75rem;color:var(--text2)">optional ID token claims</span></td>
            <td>
              roleï¼ˆç”¨æˆ· / æˆå‘˜ / ç®¡ç†å‘˜ï¼‰<br>
              nameï¼ˆéœ€è¦ profile scopeï¼‰<br>
              pictureï¼ˆéœ€è¦ profile scopeï¼‰
            </td>
          </tr>
        </tbody>
      </table>

      <div style="background:#f8fafc;border:1px solid var(--glass-b);border-radius:10px;padding:.9rem 1rem;font-size:.82rem;color:var(--text2)">
        <strong style="color:var(--text)">æ¥å…¥å¡«å†™ç¤ºä¾‹ï¼š</strong><br>
        Authorization Endpoint â†’ <code>{{$.Issuer}}/oauth2/authorize</code><br>
        Token Endpoint â†’ <code>{{$.Issuer}}/oauth2/token</code><br>
        JWKS Endpoint â†’ <code>{{$.Issuer}}/.well-known/jwks.json</code><br>
        Code Challenge Method â†’ <strong>å¼€å¯</strong>ï¼ˆæœºå¯†åº”ç”¨åŒæ ·æ”¯æŒï¼‰&emsp;
        Directory Sync â†’ <strong>å…³é—­</strong>&emsp;
        Email Field â†’ <strong>ä½¿ç”¨ç³»ç»Ÿé»˜è®¤å­—æ®µ</strong><br>
        Scope â†’ <strong>é»˜è®¤æƒé™é¡¹ï¼ˆopenid email profileï¼‰</strong>
      </div>
    </details>

    {{/* â”€â”€ ç¼–è¾‘ä¿¡æ¯ â”€â”€ */}}
    <div class="detail-section">
      <div class="detail-section-title">ç¼–è¾‘ä¿¡æ¯</div>
      <form method="POST" action="/admin/clients/{{$client.ID}}/update">
        <input type="hidden" name="csrf_token" value="{{$.CSRFToken}}">
        <div class="form-group">
          <label class="form-label">åº”ç”¨åç§°</label>
          <input class="form-control" type="text" name="name" value="{{$client.Name}}" required>
        </div>
        <div class="form-group">
          <label class="form-label">æè¿°</label>
          <input class="form-control" type="text" name="description" value="{{$client.Description}}">
        </div>
        <div class="form-group">
          <label class="form-label">å›è°ƒåœ°å€åˆ—è¡¨ï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰</label>
          <textarea class="form-control" name="redirect_uris" rows="4">{{range $client.RedirectURIs}}{{.}}
{{end}}</textarea>
        </div>
        <div class="form-group">
          <label class="form-label">æƒé™èŒƒå›´ï¼ˆç©ºæ ¼åˆ†éš”ï¼‰</label>
          <input class="form-control" type="text" name="scopes" value="{{range $client.Scopes}}{{.}} {{end}}">
        </div>
        <div class="form-group">
          <label class="form-label">åŸºç¡€è®¿é—®æƒé™</label>
          <select class="form-control" name="base_access">
            <option value="legacy" {{if eq $client.BaseAccess "legacy"}}selected{{end}}>å…¼å®¹æ¨¡å¼ï¼ˆæœ‰åˆ†ç»„åˆ™ä»…æŒ‰åˆ†ç»„ï¼Œæ— åˆ†ç»„åˆ™å…¨éƒ¨å¯è®¿é—®ï¼‰</option>
            <option value="user" {{if eq $client.BaseAccess "user"}}selected{{end}}>æ‰€æœ‰å·²ç™»å½•ç”¨æˆ·</option>
            <option value="member" {{if eq $client.BaseAccess "member"}}selected{{end}}>æˆå‘˜åŠä»¥ä¸Š</option>
            <option value="admin" {{if eq $client.BaseAccess "admin"}}selected{{end}}>ä»…ç®¡ç†å‘˜</option>
            <option value="none" {{if eq $client.BaseAccess "none"}}selected{{end}}>ä¸å¯ç”¨åŸºç¡€æƒé™ï¼ˆä»…åˆ†ç»„ï¼‰</option>
          </select>
          <span style="font-size:.78rem;color:var(--text2)">
            è®¿é—®è§„åˆ™ä¸ºã€ŒåŸºç¡€è®¿é—®æƒé™ æˆ– ä»»æ„å‘½ä¸­ä¸€ä¸ªåˆ†ç»„ã€ã€‚
          </span>
        </div>
        <div class="form-group">
          <label class="form-label">å¯è®¿é—®åˆ†ç»„ï¼ˆç©ºæ ¼åˆ†éš”ï¼‰</label>
          <input class="form-control" type="text" name="allowed_groups"
            value="{{range $client.AllowedGroups}}{{.}} {{end}}"
            placeholder="è¯·è¾“å…¥åˆ†ç»„ä»£å·">
          <span style="font-size:.78rem;color:var(--text2)">
            ç³»ç»Ÿåˆ†ç»„ç”±ç³»ç»Ÿè‡ªåŠ¨ç»´æŠ¤ï¼›è‡ªå®šä¹‰åˆ†ç»„è¯·åœ¨ã€Œåˆ†ç»„ç®¡ç†ã€é¡µé¢æŸ¥çœ‹åˆ†ç»„ä»£å·ã€‚å¤šä¸ªåˆ†ç»„å‘½ä¸­ä»»æ„ä¸€ä¸ªå³å¯ã€‚
          </span>
        </div>
        <button class="btn btn-primary btn-sm" type="submit">ä¿å­˜ä¿®æ”¹</button>
      </form>
    </div>

    {{/* â”€â”€ åº”ç”¨å…¬å‘Š â”€â”€ */}}
    <div class="detail-section">
      <div class="detail-section-title">åº”ç”¨å…¬å‘Š</div>
      <p style="font-size:.82rem;color:var(--text2);margin-bottom:.8rem">
        å…¬å‘Šå¯é€šè¿‡ <code class="mono">/api/announcement/{{$client.ClientID}}</code> å…¬å¼€è®¿é—®ã€‚
      </p>
      {{if $canManage}}
      <form method="POST" action="/admin/announcements/{{$client.ClientID}}/save">
        <input type="hidden" name="csrf_token" value="{{$.CSRFToken}}">
        <div class="form-group">
          <textarea class="form-control" name="content" rows="3" placeholder="å…¬å‘Šå†…å®¹ï¼ˆç•™ç©ºåˆ™æ¸…é™¤ï¼‰">{{$ann}}</textarea>
        </div>
        <button class="btn btn-ghost btn-sm" type="submit">ä¿å­˜å…¬å‘Š</button>
      </form>
      {{else}}
      <p style="color:var(--text2);font-size:.85rem">{{if $ann}}{{$ann}}{{else}}ï¼ˆæ— å…¬å‘Šï¼‰{{end}}</p>
      {{end}}
    </div>

    {{/* â”€â”€ ç®¡ç†æƒé™ç»„ (admin only) â”€â”€ */}}
    {{if $.CurrentUser.IsAdmin}}
    <div class="detail-section">
      <div class="detail-section-title">ç®¡ç†æƒé™ç»„</div>
      <p style="font-size:.82rem;color:var(--text2);margin-bottom:.8rem">
        è®¾ç½®å“ªäº›åˆ†ç»„çš„æˆå‘˜å¯ä»¥ç®¡ç†æ­¤åº”ç”¨ã€‚ç•™ç©ºåˆ™æ‰€æœ‰æ‹¥æœ‰ã€Œç®¡ç†åº”ç”¨ã€æƒé™çš„ç”¨æˆ·å‡å¯ç®¡ç†ã€‚
      </p>
      <form method="POST" action="/admin/clients/{{$client.ID}}/set-managers">
        <input type="hidden" name="csrf_token" value="{{$.CSRFToken}}">
        <div class="form-group">
          <select class="form-control" name="manager_groups" multiple size="5" style="height:auto">
            {{range $allGroups}}
            {{$gname := .Name}}{{$glabel := .Label}}
            <option value="{{$gname}}"
              {{range $client.ManagerGroups}}{{if eq . $gname}}selected{{end}}{{end}}>{{$glabel}} ({{$gname}})</option>
            {{end}}
          </select>
          <span style="font-size:.78rem;color:var(--text2)">æŒ‰ä½ Ctrl / Cmd å¯å¤šé€‰ï¼›ä¸é€‰å³æ¸…é™¤é™åˆ¶</span>
        </div>
        <button class="btn btn-ghost btn-sm" type="submit">ä¿å­˜ç®¡ç†æƒé™ç»„</button>
      </form>
    </div>
    {{end}}

    {{/* â”€â”€ å±é™©æ“ä½œ â”€â”€ */}}
    {{if $canManage}}
    <div class="detail-section" style="border-color:#fecaca">
      <div class="detail-section-title">å±é™©æ“ä½œ</div>
      <div style="display:flex;gap:.8rem;flex-wrap:wrap">
        <form method="POST" action="/admin/clients/{{$client.ID}}/reset-secret">
          <input type="hidden" name="csrf_token" value="{{$.CSRFToken}}">
          <button class="btn btn-ghost btn-sm" type="submit"
            data-confirm="é‡ç½®åæ—§å¯†é’¥ç«‹å³å¤±æ•ˆï¼Œæ‰€æœ‰ä½¿ç”¨æ—§å¯†é’¥çš„åº”ç”¨éƒ½éœ€è¦æ›´æ–°ã€‚" data-confirm-title="é‡ç½®åº”ç”¨å¯†é’¥" data-confirm-icon="ğŸ”‘">é‡ç½®åº”ç”¨å¯†é’¥</button>
        </form>
        <form method="POST" action="/admin/clients/{{$client.ID}}/delete">
          <input type="hidden" name="csrf_token" value="{{$.CSRFToken}}">
          <button class="btn btn-danger btn-sm" type="submit"
            data-confirm="åˆ é™¤åæ‰€æœ‰ä»¤ç‰Œå°†å¤±æ•ˆï¼Œæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚" data-confirm-title="åˆ é™¤åº”ç”¨" data-confirm-icon="âš ï¸">åˆ é™¤æ­¤åº”ç”¨</button>
        </form>
      </div>
    </div>
    {{end}}

    {{end}}
  </main>
</div>
{{end}}
