{{template "base" .}}

{{define "content"}}
<div class="panel-wrap">
  <aside class="sidebar">
    <div class="sidebar-section">
      <div class="sidebar-title">ç®¡ç†å¯¼èˆª</div>
      {{if .CurrentUser.IsAdmin}}
      <a class="sidebar-link" href="/admin">æ¦‚è§ˆ</a>
      <a class="sidebar-link active" href="/admin/users">ç”¨æˆ·</a>
      {{end}}
      <a class="sidebar-link" href="/admin/clients">åº”ç”¨</a>
      {{if .CurrentUser.IsAdmin}}
      <a class="sidebar-link" href="/admin/providers">ç™»å½•æ–¹å¼</a>
      <a class="sidebar-link" href="/admin/roles">è§’è‰²</a>
      <a class="sidebar-link" href="/admin/announcements">å…¬å‘Š</a>
      <a class="sidebar-link" href="/admin/settings">è®¾ç½®</a>
      {{end}}
    </div>
    <div class="sidebar-section">
      <div class="sidebar-title">å¿«é€Ÿå…¥å£</div>
      <a class="sidebar-link" href="/">è¿”å›é¦–é¡µ</a>
      <a class="sidebar-link" href="/profile">ä¸ªäººèµ„æ–™</a>
    </div>
  </aside>

  <main class="panel-content">
    <h1 class="panel-title">ç”¨æˆ·ç®¡ç†</h1>
    <p class="panel-sub">åˆ›å»ºç”¨æˆ·å¹¶ç®¡ç†è§’è‰²ä¸çŠ¶æ€ã€‚</p>

    {{if .Flash}}
    <div class="flash {{if .IsError}}flash-err{{else}}flash-ok{{end}}">{{.Flash}}</div>
    {{end}}

    {{$d := .Data}}
    {{$customRoles := index $d "CustomRoles"}}

    <div class="form-panel">
      <p class="form-panel-title">æ–°å¢ç”¨æˆ·</p>
      <form method="POST" action="/admin/users">
        <input type="hidden" name="csrf_token" value="{{$.CSRFToken}}">
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">é‚®ç®±</label>
            <input class="form-control" type="email" name="email" required>
          </div>
          <div class="form-group">
            <label class="form-label">æ˜¾ç¤ºåç§°</label>
            <input class="form-control" type="text" name="display_name" required>
          </div>
          <div class="form-group">
            <label class="form-label">å¯†ç </label>
            <input class="form-control" type="password" name="password" minlength="8" required>
          </div>
          <div class="form-group">
            <label class="form-label">è§’è‰²</label>
            <select class="form-control" name="role">
              <option value="user">ç”¨æˆ·</option>
              <option value="member">æˆå‘˜</option>
              <option value="admin">ç®¡ç†å‘˜</option>
              {{range $customRoles}}
              <option value="{{.Name}}">{{if .Label}}{{.Label}}{{else}}{{.Name}}{{end}}</option>
              {{end}}
            </select>
          </div>
        </div>
        <div class="form-group" style="margin-bottom:.8rem">
          <label style="display:flex;align-items:center;gap:.5rem;cursor:pointer">
            <input type="checkbox" name="require_password_change" value="1">
            <span style="font-size:.88rem">è¦æ±‚ç”¨æˆ·é¦–æ¬¡ç™»å½•åä¿®æ”¹å¯†ç </span>
          </label>
        </div>
        <button class="btn btn-primary btn-sm" type="submit">åˆ›å»ºç”¨æˆ·</button>
      </form>
    </div>

    <div class="card">
      <table class="data-table">
        <thead>
          <tr>
            <th>é‚®ç®±</th>
            <th>åç§°</th>
            <th>è§’è‰²</th>
            <th>çŠ¶æ€</th>
            <th>é‚®ç®±éªŒè¯</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody>
          {{range (index $d "Users")}}
          {{$userRole := .Role}}
          <tr>
            <td>
              <a href="/admin/users/{{.ID}}" style="font-weight:500">{{.Email}}</a>
            </td>
            <td>{{.DisplayName}}</td>
            <td>
              <span class="role-badge {{if eq .Role "admin"}}role-admin{{else if eq .Role "member"}}role-member{{else}}role-user{{end}}">
                {{if eq .Role "admin"}}ç®¡ç†å‘˜{{else if eq .Role "member"}}æˆå‘˜{{else if eq .Role "user"}}ç”¨æˆ·{{else}}{{.Role}}{{end}}
              </span>
            </td>
            <td>{{if .Active}}<span style="color:#16a34a">å¯ç”¨</span>{{else}}<span style="color:#dc2626">åœç”¨</span>{{end}}</td>
            <td>{{if .EmailVerified}}<span style="color:#16a34a;font-size:.82rem">å·²éªŒè¯</span>{{else}}<span style="color:#dc2626;font-size:.82rem">æœªéªŒè¯</span>{{end}}</td>
            <td>
              <form method="POST" action="/admin/users/{{.ID}}/update" style="display:inline-flex;align-items:center;gap:.4rem;flex-wrap:wrap"
                    onsubmit="return confirm('ç¡®è®¤ä¿®æ”¹ {{.DisplayName}} çš„èµ„æ–™ä¸è§’è‰²ï¼Ÿ');">
                <input type="hidden" name="csrf_token" value="{{$.CSRFToken}}">
                <input class="form-control" type="text" name="display_name" value="{{.DisplayName}}"
                  style="width:130px">
                <select class="form-control" name="role" style="width:120px">
                  <option value="user" {{if eq $userRole "user"}}selected{{end}}>ç”¨æˆ·</option>
                  <option value="member" {{if eq $userRole "member"}}selected{{end}}>æˆå‘˜</option>
                  <option value="admin" {{if eq $userRole "admin"}}selected{{end}}>ç®¡ç†å‘˜</option>
                  {{range $customRoles}}
                  <option value="{{.Name}}" {{if eq $userRole .Name}}selected{{end}}>{{if .Label}}{{.Label}}{{else}}{{.Name}}{{end}}</option>
                  {{end}}
                </select>
                <select class="form-control" name="active" style="width:80px">
                  <option value="1" {{if .Active}}selected{{end}}>å¯ç”¨</option>
                  <option value="0" {{if not .Active}}selected{{end}}>åœç”¨</option>
                </select>
                <button class="btn btn-ghost btn-sm" type="submit">ä¿å­˜</button>
              </form>
              <form method="POST" action="/admin/users/{{.ID}}/delete" style="display:inline-block;margin-left:.3rem">
                <input type="hidden" name="csrf_token" value="{{$.CSRFToken}}">
                <button class="btn btn-danger btn-sm" type="submit"
                  data-confirm="æ˜¯å¦ç¡®å®šåˆ é™¤ç”¨æˆ· {{.DisplayName}}ï¼Ÿè¯¥æ“ä½œä¸å¯æ’¤é”€ã€‚"
                  data-confirm-title="åˆ é™¤ç”¨æˆ·" data-confirm-icon="ğŸ—‘ï¸">åˆ é™¤</button>
              </form>
              <a class="btn btn-ghost btn-sm" href="/admin/users/{{.ID}}" style="margin-left:.3rem">è¯¦æƒ…</a>
            </td>
          </tr>
          {{else}}
          <tr><td colspan="6" style="color:var(--text2);text-align:center;padding:2rem">æš‚æ— ç”¨æˆ·æ•°æ®</td></tr>
          {{end}}
        </tbody>
      </table>
    </div>
  </main>
</div>
{{end}}
